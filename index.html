<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Fitness & Nutrition Assistant (Study Case)</title>

  <style>
    /* =========================================================
       NEW THEME (Different Look) ‚Äî "Aurora Glass"
       Edit colors quickly in :root
    ========================================================= */
    :root{
      --bgA:#0b1220;
      --bgB:#0a2a2b;
      --bgC:#2b114d;

      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.16);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --accent:#22c1c3;   /* teal */
      --accent2:#8a2be2;  /* purple */
      --accent3:#ff5ea8;  /* pink (for special highlights) */

      --ok:#2ee59d;
      --warn:#ffb020;
      --bad:#ff4d6d;
      --neutral: rgba(255,255,255,.24);

      --shadow: 0 18px 42px rgba(0,0,0,.42);
      --shadowSoft: 0 10px 24px rgba(0,0,0,.28);

      --radius: 22px;
      --radiusSm: 16px;

      --ring: 0 0 0 3px rgba(34,193,195,.25);
    }

    *{
      box-sizing:border-box;
      font-family:"Prompt", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(34,193,195,.22), transparent 60%),
        radial-gradient(900px 520px at 90% 25%, rgba(138,43,226,.22), transparent 62%),
        radial-gradient(700px 460px at 50% 92%, rgba(255,94,168,.12), transparent 60%),
        linear-gradient(135deg, var(--bgA), var(--bgB) 45%, var(--bgC));
      padding-bottom: 92px; /* bottom nav space */
    }

    .hide{ display:none !important; }

    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      max-width: 560px;
      margin: 14px auto;
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    h2, h3{
      text-align:center;
      margin: 10px 0;
      letter-spacing: .2px;
    }

    p{ line-height:1.55; color: var(--muted); }

    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      margin: 7px 0;
      border-radius: var(--radiusSm);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.55); }
    select{ appearance:none; }
    textarea{ min-height: 95px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(34,193,195,.55);
      box-shadow: var(--ring);
      background: rgba(255,255,255,.09);
    }

    /* Buttons: softer, modern, gradient */
    button{
      width:100%;
      padding: 13px 14px;
      margin-top: 10px;
      border:none;
      border-radius: 18px;
      color: #081018;
      cursor:pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadowSoft);
      font-weight: 700;
      letter-spacing: .2px;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    button:active{ transform: translateY(1px); filter: brightness(.98); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Status colors */
    .green{ background: linear-gradient(135deg, var(--ok), rgba(34,193,195,.7)); color:#04120c; }
    .red{ background: linear-gradient(135deg, var(--bad), rgba(255,94,168,.75)); color:#16040b; }
    .orange{ background: linear-gradient(135deg, var(--warn), rgba(255,94,168,.55)); color:#140c02; }
    .gray{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: none;
    }

    .outline{
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: none;
    }
    .outline:hover{
      border-color: rgba(34,193,195,.55);
      box-shadow: 0 0 0 3px rgba(34,193,195,.14);
      transform: translateY(-1px);
    }
    .outline:active{ transform: translateY(1px); }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
      .card{ margin: 12px 12px; }
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      margin: 4px 6px 0 0;
      color: rgba(255,255,255,.86);
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow:hidden;
      border-radius: var(--radiusSm);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
    }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,.12);
      padding: 9px 8px;
      text-align:center;
      color: rgba(255,255,255,.86);
    }
    th{
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      font-weight: 800;
    }
    tr:nth-child(even) td{ background: rgba(255,255,255,.03); }

    .disclaimer{
      font-size: 12px;
      padding: 10px 12px;
      border-radius: var(--radiusSm);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      margin-top: 10px;
      white-space: pre-line;
      color: rgba(255,255,255,.80);
    }

    /* Bottom nav: floating glass bar + pill tabs */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px 16px;
      z-index: 1000;
      pointer-events: none;
    }
    .nav-wrap{
      pointer-events: auto;
      max-width: 560px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      padding: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .tab{
      border-radius: 999px;
      padding: 10px 6px;
      text-align:center;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.82);
      font-weight: 800;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(34,193,195,.45); }
    .tab.active{
      background: linear-gradient(135deg, rgba(34,193,195,.95), rgba(138,43,226,.95));
      color: #061018;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(34,193,195,.18);
    }

    /* Tutorial overlay: cleaner */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .overlay-card{
      width:100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.16);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 18px 44px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      color: var(--text);
    }
    .overlay-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .step{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      color: rgba(255,255,255,.88);
    }
    .highlight{
      outline: 3px solid rgba(255,94,168,.75);
      outline-offset: 3px;
      border-radius: 14px;
      transition: outline .15s ease;
    }

    /* Admin terminal box */
    .admin-box{
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.88);
      padding: 12px;
      border-radius: var(--radiusSm);
      max-height: 360px;
      overflow:auto;
      border: 1px solid rgba(255,255,255,.12);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    /* Small header bar */
    .topbar{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
    }
    .topbar .who{ font-weight: 900; }
    .topbar .lang{ font-size: 12px; opacity: .82; color: var(--muted); }

    .muted{ opacity: .82; color: var(--muted); }

    .miniBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniBtns button{ width:auto; flex:1; min-width:120px; margin-top:8px; }

    .dangerNote{
      font-size: 12px;
      opacity: .92;
      margin-top: 10px;
      line-height: 1.5;
      color: rgba(255,255,255,.78);
    }

    .section{
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      margin-top: 10px;
    }
    .right{ display:flex; justify-content:flex-end; }
  </style>
</head>

<body>

  <!-- ============ AUTH SCREENS ============ -->
  <div class="card" id="registerBox">
    <h2 id="t_reg_title">üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
    <input id="rUser" placeholder="Username" autocomplete="username" />
    <input id="rPass" type="password" placeholder="Password" autocomplete="new-password" />
    <input id="rEmail" placeholder="Email" />

    <div class="row">
      <input id="rName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" />
      <input id="rLname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
    </div>

    <div class="row">
      <input id="rAge" type="number" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" />
      <select id="rGender">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="row">
      <input id="rWeight" type="number" placeholder="Weight (kg)" />
      <input id="rHeight" type="number" placeholder="Height (cm)" />
    </div>

    <select id="rGoal">
      <option value="lose">Lose weight</option>
      <option value="maintain">Maintain</option>
      <option value="gain">Gain muscle</option>
    </select>

    <select id="rLang">
      <option value="en">English (ENG)</option>
      <option value="th">‡πÑ‡∏ó‡∏¢ (THA)</option>
    </select>

    <button id="btnRegister" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
    <button class="gray" id="btnGoLogin" onclick="showLogin()">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>

    <div class="disclaimer" id="t_disclaimer_auth"></div>
  </div>

  <div class="card hide" id="loginBox">
    <h2 id="t_login_title">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
    <input id="lUser" placeholder="Username" autocomplete="username" />
    <input id="lPass" type="password" placeholder="Password" autocomplete="current-password" />

    <label class="muted" style="display:flex;align-items:center;gap:8px;margin-top:8px">
      <input type="checkbox" id="rememberMe" style="width:auto;transform:scale(1.15);margin:0">
      <span id="t_remember">Remember me (Auto login)</span>
    </label>

    <button id="btnLogin" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>

    <button class="orange" id="btnForgot" onclick="showForgot()">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (OTP ‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
    <button class="gray" id="btnGoRegister" onclick="showRegister()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>

    <div class="disclaimer" id="t_disclaimer_auth2"></div>
  </div>

  <div class="card hide" id="forgotBox">
    <h2 id="t_forgot_title">üìß ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</h2>
    <input id="fEmail" placeholder="Email" />
    <button id="btnSendOTP" onclick="sendOTP()">‡∏Ç‡∏≠ OTP</button>
    <input id="fOTP" placeholder="OTP" />
    <input id="fNewPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà" />
    <button class="green" id="btnReset" onclick="resetPassword()">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà</button>
    <button class="gray" id="btnCancelReset" onclick="showLogin()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

    <div class="disclaimer" id="t_disclaimer_otp"></div>
  </div>

  <!-- ============ USER APP ============ -->
  <div class="card hide" id="appBox">
    <div class="topbar">
      <div>
        <div class="who" id="welcome"></div>
        <div class="lang" id="topLang"></div>
      </div>
      <button class="outline" style="width:auto;padding:10px 12px;border-radius:14px" id="btnLogoutTop" onclick="logout()">
        Logout
      </button>
    </div>

    <!-- Screens -->
    <div id="screenHome">
      <h3 id="t_home_title">üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</h3>
      <div id="homeBadges"></div>

      <div class="disclaimer" id="t_home_disclaimer"></div>

      <h3 id="t_progress_title">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
      <div id="homeOverview"></div>
    </div>

    <div id="screenFood" class="hide">
      <h3 id="t_food_title">üçΩ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ & ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ</h3>

      <div class="row">
        <select id="foodDay">
          <option value="today">Today</option>
        </select>
        <button class="outline" id="btnRecalcTarget" onclick="renderFood()">
          Recalculate
        </button>
      </div>

      <div id="calorieSummary"></div>

      <button id="btnGenMeals" onclick="generateMeals()">Generate AI Meals</button>
      <div class="disclaimer" id="t_ai_disclaimer"></div>

      <div id="aiMealTable"></div>

      <h3 id="t_intake_title">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</h3>

      <div class="section">
        <div class="row">
          <input id="intakeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" />
          <input id="intakeCal" type="number" placeholder="‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ" />
        </div>

        <div class="miniBtns">
          <button class="green" id="btnAddIntake" onclick="addIntake()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          <button class="gray" id="btnQuick200" onclick="quickAdd(200)">+200</button>
          <button class="gray" id="btnQuick500" onclick="quickAdd(500)">+500</button>
          <button class="gray" id="btnQuick800" onclick="quickAdd(800)">+800</button>
        </div>

        <div class="row" style="margin-top:8px">
          <input id="manualGoal" type="number" placeholder="‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤ kcal/‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1800)" />
          <button class="outline" id="btnSaveManualGoal" onclick="saveManualGoal()">Save goal</button>
        </div>

        <div class="dangerNote" id="t_calorie_note"></div>
      </div>

      <h3 id="t_today_log">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
      <div id="intakeLogTable"></div>

      <h3 id="t_history_title">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
      <div id="historyTable"></div>
    </div>

    <div id="screenWorkout" class="hide">
      <h3 id="t_workout_title">üèãÔ∏è ‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</h3>

      <div class="row">
        <select id="wLevel">
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
        <select id="wGoal">
          <option value="fatloss">Fat loss</option>
          <option value="musclegain">Muscle gain</option>
          <option value="general">General fitness</option>
        </select>
      </div>

      <div class="row">
        <select id="wDays">
          <option value="3">3 days / week</option>
          <option value="4">4 days / week</option>
          <option value="5">5 days / week</option>
          <option value="6">6 days / week</option>
        </select>
        <select id="wEquip">
          <option value="gym">Gym</option>
          <option value="home">Home</option>
          <option value="none">No equipment</option>
        </select>
      </div>

      <button id="btnGenWorkout" onclick="generateWorkout()">Generate AI Workout Plan</button>
      <button class="orange" id="btnRegenWorkout" onclick="generateWorkout(true)">Regenerate Plan</button>

      <div class="disclaimer" id="t_workout_ai_disclaimer"></div>

      <div id="workoutPlan"></div>

      <h3 id="t_edit_title">‚úçÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ô‡πâ‡∏ï (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</h3>
      <textarea id="workoutNotes" placeholder="Edit or write notes here..."></textarea>
      <button class="green" id="btnSaveNotes" onclick="saveWorkoutNotes()">Save Notes</button>
    </div>

    <div id="screenProfile" class="hide">
      <h3 id="t_profile_title">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
      <div id="profileInfo"></div>

      <h3 id="t_profile_goal">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™</h3>
      <select id="profileGoal">
        <option value="lose">Lose weight</option>
        <option value="maintain">Maintain</option>
        <option value="gain">Gain muscle</option>
      </select>
      <button class="green" id="btnSaveProfile" onclick="saveProfile()">Save Profile</button>

      <div class="disclaimer" id="t_profile_disclaimer"></div>
    </div>

    <div id="screenSettings" class="hide">
      <h3 id="t_settings_title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>

      <label class="muted" id="t_lang_label">Language</label>
      <select id="langSwitch" onchange="changeLanguage(this.value)">
        <option value="en">English (ENG)</option>
        <option value="th">‡πÑ‡∏ó‡∏¢ (THA)</option>
      </select>

      <button class="outline" id="btnReplayTutorial" onclick="startUserTutorial(true)">Replay Tutorial</button>

      <div class="disclaimer" id="t_settings_disclaimer"></div>

      <h3 id="t_admin_hint_title">üîí Admin Access (Hidden)</h3>
      <p class="muted" id="t_admin_hint_body"></p>

      <div class="dangerNote" id="t_admin_longpress"></div>
    </div>

    <button class="red" id="btnLogout" onclick="logout()">Logout</button>
  </div>

  <!-- ============ ADMIN PANEL ============ -->
  <div class="card hide" id="adminBox">
    <div class="topbar">
      <div>
        <div class="who" id="adminTitle">üîí Admin Panel</div>
        <div class="lang" id="adminLang"></div>
      </div>
      <button class="outline" style="width:auto;padding:10px 12px;border-radius:14px" id="btnAdminLogoutTop" onclick="logout()">
        Logout
      </button>
    </div>

    <div class="disclaimer" id="t_admin_disclaimer"></div>

    <div class="section">
      <input id="adminSearch" placeholder="Search user/email/lang/goal..." />
      <div class="dangerNote" id="t_admin_rules"></div>
    </div>

    <div id="adminStats"></div>
    <div class="admin-box" id="adminData"></div>

    <button class="outline" id="btnReplayAdminTutorial" onclick="startAdminTutorial(true)">Replay Admin Tutorial</button>
    <button class="red" id="btnAdminLogout" onclick="logout()">Logout</button>
  </div>

  <!-- Bottom nav (user only) -->
  <div class="bottom-nav hide" id="bottomNav">
    <div class="nav-wrap">
      <div class="tab active" id="tabHome" onclick="goTab('home')">Home</div>
      <div class="tab" id="tabFood" onclick="goTab('food')">Food</div>
      <div class="tab" id="tabWorkout" onclick="goTab('workout')">Workout</div>
      <div class="tab" id="tabProfile" onclick="goTab('profile')">Profile</div>
      <div class="tab" id="tabSettings" onclick="goTab('settings')">Settings</div>
    </div>
  </div>

  <!-- Tutorial overlay -->
  <div class="overlay hide" id="tutorialOverlay">
    <div class="overlay-card">
      <div class="overlay-top">
        <div class="step" id="tutorialStepLabel">Step 1/6</div>
        <button class="outline" style="width:auto;padding:8px 10px;border-radius:12px" id="btnTutorialSkip" onclick="tutorialSkip()">Skip</button>
      </div>
      <h3 id="tutorialTitle" style="text-align:left;margin:10px 0 6px"></h3>
      <p id="tutorialBody" style="margin:0 0 12px"></p>
      <div class="disclaimer" id="tutorialDisclaimer"></div>

      <div class="row" style="margin-top:10px">
        <button class="gray" id="btnTutorialBack" onclick="tutorialBack()">Back</button>
        <button class="green" id="btnTutorialNext" onclick="tutorialNext()">Next</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   i18n (ENG/TH)
========================================================= */
const I18N = {
  en: {
    appStudy: "This application and all data shown are for classroom study purposes only.",
    noMedical: "AI-generated suggestions (not medical advice).",
    authDis: "Study case only. All accounts and data are fictional/mocked.\nPasswords are stored as plain text for classroom demo (not for real-world use).",
    adminDis: "Admin access is for academic study purposes only. No real personal data is used. Read-only view.",
    adminHintTitle: "Admin Access (Hidden)",
    adminHintBody: "Study hint: you can login with admin account (username: admin, password: admin123).",
    remember: "Remember me (Auto login)",
    calorieNote: "* Calories and logs are for educational mock/demo only (not medical advice).",
    longPress: "Tip: Long-press the Settings title for ~1.2s to reveal Admin hint (study-only).",
    adminRules: "Admin restrictions: No password access ‚Ä¢ No export ‚Ä¢ No editing ‚Ä¢ Read-only",

    regTitle: "üìù Register",
    loginTitle: "üîê Login",
    forgotTitle: "üìß Reset Password (Mock)",
    btnRegister: "Register",
    btnGoLogin: "Go to Login",
    btnLogin: "Login",
    btnForgot: "Forgot password (Mock OTP)",
    btnGoRegister: "Register",
    btnSendOTP: "Request OTP",
    btnReset: "Set new password",
    btnCancelReset: "Cancel",
    logout: "Logout",

    phUser: "Username",
    phPass: "Password",
    phEmail: "Email",
    phFname: "First name",
    phLname: "Last name",
    phAge: "Age",
    phWeight: "Weight (kg)",
    phHeight: "Height (cm)",

    tabs: { home:"Home", food:"Food", workout:"Workout", profile:"Profile", settings:"Settings" },

    homeTitle: "üè† Home",
    homeDisc: "This app helps plan workouts and manage food calories using AI (study case). Not medical advice.",
    progressTitle: "üìà Today Overview",

    foodTitle: "üçΩ Food & Calories",
    recalc: "Recalculate",
    genMeals: "Generate AI Meals",
    intakeTitle: "‚ûï Log Intake (Mock)",
    addIntake: "Add intake",
    todayLog: "üìã Today intake list",
    historyTitle: "üìä Daily History",
    saveGoal: "Save goal",

    workoutTitle: "üèãÔ∏è Workout Plan",
    genWorkout: "Generate AI Workout Plan",
    regenWorkout: "Regenerate Plan",
    editTitle: "‚úçÔ∏è Edit Notes (Optional)",
    saveNotes: "Save Notes",

    profileTitle: "üë§ Profile",
    profileGoal: "üéØ Fitness Goal",
    saveProfile: "Save Profile",
    profileDisc: "Profile is stored locally (mock).",

    settingsTitle: "‚öôÔ∏è Settings",
    langLabel: "Language",
    replayTut: "Replay Tutorial",
    settingsDisc: "Tutorial language follows current app language.",

    // Errors
    errFill: "Please fill required fields.",
    errDupUser: "Username already exists.",
    errLogin: "Incorrect username or password.",
    errNoEmail: "Email not found.",
    errOtp: "Invalid OTP.",
    errIntake: "Please input food name and calories.",
    errGoal: "Please input a valid calorie goal.",

    // Food text
    calTarget: "Recommended calorie target",
    calIntake: "Logged intake today",
    calRemaining: "Remaining",
    mealPlanTitle: "AI Meal Plan (Mock)",
    time: "Time",
    meal: "Meal",
    calories: "Calories",
    total: "Total",
    breakfast:"Breakfast", lunch:"Lunch", dinner:"Dinner", snack:"Snack",

    // Workout text
    weeklyPlan: "Weekly Plan",
    day: "Day",
    exercise: "Exercise",
    sets: "Sets",
    reps: "Reps",
    rest: "Rest",
    seconds: "sec",

    // Tutorials (User 6 steps)
    tutUserSteps: [
      { title:"Welcome", body:"This app helps you plan workouts and manage food calories using AI." , step:"Step 1/6", highlight:null },
      { title:"Navigation Overview", body:"Use bottom tabs: Home (overview), Food (AI meals), Workout (AI plan), Profile (your data), Settings (language & tutorial).", step:"Step 2/6", highlight:"bottomNav" },
      { title:"Food & Calories", body:"AI recommends meals and estimates calories. You can also log intake to compare vs your target.", step:"Step 3/6", highlight:"tabFood" },
      { title:"Workout Generator", body:"Enter your level, goal, days per week, and equipment. Then generate or regenerate your weekly plan.", step:"Step 4/6", highlight:"tabWorkout" },
      { title:"Language Switch", body:"Go to Settings ‚Üí Language ‚Üí ENG/TH. All UI and AI messages will switch.", step:"Step 5/6", highlight:"tabSettings" },
      { title:"Finish", body:"You‚Äôre ready to use the app!", step:"Step 6/6", highlight:null }
    ],

    // Tutorials (Admin 5 steps)
    tutAdminSteps: [
      { title:"Admin Access Warning", body:"Admin panel is for academic study only. Do not misuse user data.", step:"Step 1/5", highlight:null },
      { title:"Dashboard Overview", body:"You can view user list and summary statistics (number of users, languages used).", step:"Step 2/5", highlight:"adminStats" },
      { title:"User Information View", body:"Visible fields: User ID, Username, Email, Selected language, Fitness goal. Data is read-only.", step:"Step 3/5", highlight:"adminData" },
      { title:"Data Limitations", body:"Restrictions: No password access, no export, no editing.", step:"Step 4/5", highlight:"adminData" },
      { title:"Exit Admin Mode", body:"Always log out after reviewing data.", step:"Step 5/5", highlight:"btnAdminLogout" }
    ]
  },

  th: {
    appStudy: "‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
    noMedical: "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£)",
    authDis: "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á\n‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á)",
    adminDis: "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß",
    adminHintTitle: "‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ)",
    adminHintBody: "‡∏ó‡∏¥‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ admin ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login (username: admin, password: admin123)",
    remember: "‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ (‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)",
    calorieNote: "* ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå)",
    longPress: "‡∏ó‡∏¥‡∏õ: ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Settings ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1.2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)",
    adminRules: "‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Ä¢ Export ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Ä¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Ä¢ ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß",

    regTitle: "üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
    loginTitle: "üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    forgotTitle: "üìß ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    btnRegister: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
    btnGoLogin: "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    btnLogin: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    btnForgot: "‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (OTP ‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    btnGoRegister: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
    btnSendOTP: "‡∏Ç‡∏≠ OTP",
    btnReset: "‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà",
    btnCancelReset: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    logout: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",

    phUser: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)",
    phPass: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
    phEmail: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    phFname: "‡∏ä‡∏∑‡πà‡∏≠",
    phLname: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    phAge: "‡∏≠‡∏≤‡∏¢‡∏∏",
    phWeight: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)",
    phHeight: "‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)",

    tabs: { home:"‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", food:"‡∏≠‡∏≤‡∏´‡∏≤‡∏£", workout:"‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á", profile:"‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå", settings:"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" },

    homeTitle: "üè† ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
    homeDisc: "‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå",
    progressTitle: "üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",

    foodTitle: "üçΩ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ & ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ",
    recalc: "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà",
    genMeals: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI",
    intakeTitle: "‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    addIntake: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
    todayLog: "üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
    historyTitle: "üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô",
    saveGoal: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤",

    workoutTitle: "üèãÔ∏è ‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢",
    genWorkout: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AI",
    regenWorkout: "‡∏™‡∏∏‡πà‡∏°/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà",
    editTitle: "‚úçÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ô‡πâ‡∏ï (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)",
    saveNotes: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ô‡πâ‡∏ï",

    profileTitle: "üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå",
    profileGoal: "üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™",
    saveProfile: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå",
    profileDisc: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á)",

    settingsTitle: "‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
    langLabel: "‡∏†‡∏≤‡∏©‡∏≤",
    replayTut: "‡πÄ‡∏•‡πà‡∏ô Tutorial ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    settingsDisc: "‡∏†‡∏≤‡∏©‡∏≤ Tutorial ‡∏à‡∏∞‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ",

    errFill: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö",
    errDupUser: "Username ‡∏ã‡πâ‡∏≥",
    errLogin: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    errNoEmail: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ",
    errOtp: "OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    errIntake: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ",
    errGoal: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",

    calTarget: "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
    calIntake: "‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
    calRemaining: "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
    mealPlanTitle: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å AI (‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    time: "‡∏°‡∏∑‡πâ‡∏≠",
    meal: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
    calories: "‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ",
    total: "‡∏£‡∏ß‡∏°",
    breakfast:"‡πÄ‡∏ä‡πâ‡∏≤", lunch:"‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á", dinner:"‡πÄ‡∏¢‡πá‡∏ô", snack:"‡∏ß‡πà‡∏≤‡∏á",

    weeklyPlan: "‡πÅ‡∏ú‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå",
    day: "‡∏ß‡∏±‡∏ô",
    exercise: "‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á",
    sets: "‡πÄ‡∏ã‡πá‡∏ï",
    reps: "‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    rest: "‡∏û‡∏±‡∏Å",
    seconds: "‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ",

    tutUserSteps: [
      { title:"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö", body:"‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1/6", highlight:null },
      { title:"‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ô‡∏π", body:"‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡πá‡∏ö‡∏•‡πà‡∏≤‡∏á: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (‡∏™‡∏£‡∏∏‡∏õ), ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÄ‡∏°‡∏ô‡∏π AI), ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á (‡πÅ‡∏ú‡∏ô AI), ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•), ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏†‡∏≤‡∏©‡∏≤ & Tutorial)", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2/6", highlight:"bottomNav" },
      { title:"‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ & ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ", body:"AI ‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3/6", highlight:"tabFood" },
      { title:"‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢", body:"‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ú‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÑ‡∏î‡πâ", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4/6", highlight:"tabWorkout" },
      { title:"‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤", body:"‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚Üí ‡∏†‡∏≤‡∏©‡∏≤ ‚Üí ENG/TH ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å AI ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 5/6", highlight:"tabSettings" },
      { title:"‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", body:"‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 6/6", highlight:null }
    ],

    tutAdminSteps: [
      { title:"‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô", body:"‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ú‡∏¥‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1/5", highlight:null },
      { title:"‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Dashboard", body:"‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏£‡∏∏‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/‡∏†‡∏≤‡∏©‡∏≤)", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2/5", highlight:"adminStats" },
      { title:"‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", body:"‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ: User ID, Username, Email, ‡∏†‡∏≤‡∏©‡∏≤, ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™ (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3/5", highlight:"adminData" },
      { title:"‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", body:"‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°: ‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ, Export ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4/5", highlight:"adminData" },
      { title:"‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", body:"‡∏Ñ‡∏ß‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 5/5", highlight:"btnAdminLogout" }
    ]
  }
};

/* =========================================================
   DOM refs
========================================================= */
const registerBox = document.getElementById("registerBox");
const loginBox = document.getElementById("loginBox");
const forgotBox = document.getElementById("forgotBox");
const appBox = document.getElementById("appBox");
const adminBox = document.getElementById("adminBox");
const bottomNav = document.getElementById("bottomNav");

const welcome = document.getElementById("welcome");
const topLang = document.getElementById("topLang");

const screenHome = document.getElementById("screenHome");
const screenFood = document.getElementById("screenFood");
const screenWorkout = document.getElementById("screenWorkout");
const screenProfile = document.getElementById("screenProfile");
const screenSettings = document.getElementById("screenSettings");

const aiMealTable = document.getElementById("aiMealTable");
const historyTable = document.getElementById("historyTable");
const calorieSummary = document.getElementById("calorieSummary");
const intakeLogTable = document.getElementById("intakeLogTable");

const workoutPlan = document.getElementById("workoutPlan");
const workoutNotes = document.getElementById("workoutNotes");

/* tutorial */
const tutorialOverlay = document.getElementById("tutorialOverlay");
const tutorialStepLabel = document.getElementById("tutorialStepLabel");
const tutorialTitle = document.getElementById("tutorialTitle");
const tutorialBody = document.getElementById("tutorialBody");
const tutorialDisclaimer = document.getElementById("tutorialDisclaimer");
const btnTutorialSkip = document.getElementById("btnTutorialSkip");
const btnTutorialBack = document.getElementById("btnTutorialBack");
const btnTutorialNext = document.getElementById("btnTutorialNext");

/* admin */
const adminData = document.getElementById("adminData");
const adminStats = document.getElementById("adminStats");
const adminLang = document.getElementById("adminLang");
const adminSearch = document.getElementById("adminSearch");

/* =========================================================
   Storage
========================================================= */
const LS_USERS = "users";
const LS_UI_LANG = "uiLang";
const LS_SESSION_USER = "session_user"; // remember me username

function uid() {
  return "U" + Math.random().toString(16).slice(2, 10).toUpperCase();
}
function save(){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
function loadUsers(){ try { return JSON.parse(localStorage.getItem(LS_USERS) || "[]"); } catch { return []; } }

function getUiLang(){ return localStorage.getItem(LS_UI_LANG) || "en"; }
function setUiLang(lang){ localStorage.setItem(LS_UI_LANG, lang); }

/* sanitize (stability) */
function sanitizeUsers(list){
  if(!Array.isArray(list)) return [];
  const cleaned = [];
  for(const u of list){
    if(!u || typeof u !== "object") continue;
    if(typeof u.user !== "string" || !u.user.trim()) continue;
    if(typeof u.pass !== "string") continue;

    cleaned.push({
      id: u.id || uid(),
      user: u.user.trim(),
      pass: u.pass,
      email: (u.email || "").trim(),
      name: (u.name || "").trim(),
      lname: (u.lname || "").trim(),
      age: Number(u.age || 0),
      gender: u.gender || "other",
      weight: Number(u.weight || 0),
      height: Number(u.height || 0),
      goal: u.goal || "maintain",
      lang: u.lang || "en",
      role: (u.role === "admin") ? "admin" : "user",
      history: (u.history && typeof u.history === "object") ? u.history : {},
      workoutPlan: u.workoutPlan || null,
      workoutNotes: u.workoutNotes || "",
      firstLaunchDone: !!u.firstLaunchDone,
      firstAdminTutDone: !!u.firstAdminTutDone,
      online: !!u.online
    });
  }

  // dedup username (case-insensitive)
  const seen = new Set();
  const out = [];
  for(const u of cleaned){
    const key = u.user.toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(u);
  }
  return out;
}

let users = sanitizeUsers(loadUsers());
let currentUser = null;

let otpTemp = null;
let otpEmail = null;

/* seed admin */
if (!users.find(u => u.user.toLowerCase() === "admin")) {
  users.push({
    id: "ADMIN-0001",
    user: "admin",
    pass: "admin123",
    email: "admin@local",
    name: "Admin",
    lname: "System",
    age: 0,
    gender: "other",
    weight: 0,
    height: 0,
    goal: "maintain",
    lang: "en",
    role: "admin",
    history: {},
    workoutPlan: null,
    workoutNotes: "",
    firstLaunchDone: true,
    firstAdminTutDone: false,
    online: false
  });
  save();
}

/* =========================================================
   Helpers
========================================================= */
function todayKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function t(key) {
  const lang = (currentUser?.lang) || getUiLang() || "en";
  const dict = I18N[lang] || I18N.en;

  const parts = key.split(".");
  let cur = dict;
  for (const p of parts) cur = (cur && cur[p] !== undefined) ? cur[p] : null;
  return (cur !== null && cur !== undefined) ? cur : key;
}

function setText(id, text) {
  const el = document.getElementById(id);
  if (el) el.innerText = text;
}

function hideAll(){
  registerBox.classList.add("hide");
  loginBox.classList.add("hide");
  forgotBox.classList.add("hide");
  appBox.classList.add("hide");
  adminBox.classList.add("hide");
  bottomNav.classList.add("hide");
}

/* FIX: do NOT force EN */
function showLogin(){ hideAll(); loginBox.classList.remove("hide"); applyStaticI18n(getUiLang()); }
function showRegister(){ hideAll(); registerBox.classList.remove("hide"); applyStaticI18n(getUiLang()); }
function showForgot(){ hideAll(); forgotBox.classList.remove("hide"); applyStaticI18n(getUiLang()); }

/* =========================================================
   Apply i18n (static auth uses uiLang)
========================================================= */
function applyStaticI18n(forceLang){
  const lang = forceLang || getUiLang();
  const dict = I18N[lang] || I18N.en;

  setText("t_reg_title", dict.regTitle);
  setText("t_login_title", dict.loginTitle);
  setText("t_forgot_title", dict.forgotTitle);

  document.getElementById("rUser").placeholder = dict.phUser;
  document.getElementById("rPass").placeholder = dict.phPass;
  document.getElementById("rEmail").placeholder = dict.phEmail;
  document.getElementById("rName").placeholder = dict.phFname;
  document.getElementById("rLname").placeholder = dict.phLname;
  document.getElementById("rAge").placeholder = dict.phAge;
  document.getElementById("rWeight").placeholder = dict.phWeight;
  document.getElementById("rHeight").placeholder = dict.phHeight;

  document.getElementById("lUser").placeholder = dict.phUser;
  document.getElementById("lPass").placeholder = dict.phPass;
  document.getElementById("fEmail").placeholder = dict.phEmail;
  document.getElementById("fOTP").placeholder = "OTP";
  document.getElementById("fNewPass").placeholder = (lang === "th") ? "‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà" : "New password";

  setText("btnRegister", dict.btnRegister);
  setText("btnGoLogin", dict.btnGoLogin);
  setText("btnLogin", dict.btnLogin);
  setText("btnForgot", dict.btnForgot);
  setText("btnGoRegister", dict.btnGoRegister);
  setText("btnSendOTP", dict.btnSendOTP);
  setText("btnReset", dict.btnReset);
  setText("btnCancelReset", dict.btnCancelReset);

  setText("t_disclaimer_auth", `${dict.authDis}\n${dict.appStudy}`);
  setText("t_disclaimer_auth2", `${dict.authDis}\n${dict.appStudy}`);
  setText("t_disclaimer_otp", `${dict.authDis}\n${dict.appStudy}`);

  setText("t_remember", dict.remember);

  const rLang = document.getElementById("rLang");
  if (rLang && (rLang.value !== lang)) rLang.value = lang;
}

/* =========================================================
   Auth
========================================================= */
function register(){
  const rUser = document.getElementById("rUser").value.trim();
  const rPass = document.getElementById("rPass").value.trim();
  const rEmail = document.getElementById("rEmail").value.trim();

  const rName = document.getElementById("rName").value.trim();
  const rLname = document.getElementById("rLname").value.trim();
  const rAge = Number(document.getElementById("rAge").value || 0);
  const rGender = document.getElementById("rGender").value;
  const rWeight = Number(document.getElementById("rWeight").value || 0);
  const rHeight = Number(document.getElementById("rHeight").value || 0);
  const rGoal = document.getElementById("rGoal").value;
  const rLang = document.getElementById("rLang").value;

  setUiLang(rLang);
  applyStaticI18n(rLang);

  if(!rUser || !rPass || !rEmail){ alert(I18N[rLang].errFill); return; }
  if(users.find(u => u.user.toLowerCase() === rUser.toLowerCase())){ alert(I18N[rLang].errDupUser); return; }

  users.push({
    id: uid(),
    user: rUser,
    pass: rPass,
    email: rEmail,
    name: rName || rUser,
    lname: rLname || "",
    age: rAge || 0,
    gender: rGender,
    weight: rWeight || 0,
    height: rHeight || 0,
    goal: rGoal,
    lang: rLang,
    role: "user",
    history: {},
    workoutPlan: null,
    workoutNotes: "",
    firstLaunchDone: false,
    firstAdminTutDone: false,
    online: false
  });

  users = sanitizeUsers(users);
  save();
  alert(rLang === "th" ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ" : "Registered successfully ‚úÖ");
  showLogin();
}

function login(){
  const uiLang = getUiLang();
  const uName = document.getElementById("lUser").value.trim();
  const uPass = document.getElementById("lPass").value.trim();

  const u = users.find(x => x.user.toLowerCase() === uName.toLowerCase() && x.pass === uPass);
  if(!u){ alert(I18N[uiLang].errLogin); return; }

  currentUser = u;
  currentUser.online = true;
  setUiLang(currentUser.lang);
  save();

  // remember me
  const remember = document.getElementById("rememberMe").checked;
  if(remember) localStorage.setItem(LS_SESSION_USER, currentUser.user);
  else localStorage.removeItem(LS_SESSION_USER);

  hideAll();

  if(currentUser.role === "admin"){
    adminBox.classList.remove("hide");
    adminLang.innerText = `Language: ${currentUser.lang.toUpperCase()}`;
    applyAppI18n();
    renderAdmin();
    startAdminTutorial(false);
  } else {
    appBox.classList.remove("hide");
    bottomNav.classList.remove("hide");
    bootUserApp();
  }
}

function logout(){
  if(currentUser) currentUser.online = false;
  save();
  localStorage.removeItem(LS_SESSION_USER);
  location.reload();
}

/* OTP mock */
function sendOTP(){
  const lang = getUiLang();
  const email = document.getElementById("fEmail").value.trim();
  const u = users.find(x => x.email.toLowerCase() === email.toLowerCase());
  if(!u){ alert(I18N[lang].errNoEmail); return; }
  otpTemp = Math.floor(100000 + Math.random() * 900000);
  otpEmail = u.email;
  alert((lang === "th" ? "OTP (‡∏à‡∏≥‡∏•‡∏≠‡∏á): " : "OTP (Mock): ") + otpTemp);
}
function resetPassword(){
  const lang = getUiLang();
  const otp = document.getElementById("fOTP").value.trim();
  const newPass = document.getElementById("fNewPass").value.trim();
  if(!otpTemp || otp !== String(otpTemp)){ alert(I18N[lang].errOtp); return; }
  const u = users.find(x => x.email === otpEmail);
  if(u) u.pass = newPass;
  otpTemp = null; otpEmail = null;
  save();
  alert(lang === "th" ? "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "Password updated ‚úÖ");
  showLogin();
}

/* =========================================================
   App boot / i18n
========================================================= */
function bootUserApp(){
  welcome.innerText = (currentUser.lang === "th") ? `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${currentUser.name}` : `Hello ${currentUser.name}`;
  topLang.innerText = `Language: ${currentUser.lang.toUpperCase()}`;
  document.getElementById("langSwitch").value = currentUser.lang;

  applyAppI18n();
  ensureTodayHistory();
  goTab("home", true);
  startUserTutorial(false);
}

function applyAppI18n(){
  // tabs
  document.getElementById("tabHome").innerText = t("tabs.home");
  document.getElementById("tabFood").innerText = t("tabs.food");
  document.getElementById("tabWorkout").innerText = t("tabs.workout");
  document.getElementById("tabProfile").innerText = t("tabs.profile");
  document.getElementById("tabSettings").innerText = t("tabs.settings");

  // headings
  setText("t_home_title", t("homeTitle"));
  setText("t_home_disclaimer", `${t("homeDisc")}\n${t("appStudy")}`);
  setText("t_progress_title", t("progressTitle"));

  setText("t_food_title", t("foodTitle"));
  setText("btnRecalcTarget", t("recalc"));
  setText("btnGenMeals", t("genMeals"));
  setText("t_ai_disclaimer", `${t("noMedical")} ‚Ä¢ ${t("appStudy")}`);

  setText("t_intake_title", t("intakeTitle"));
  document.getElementById("intakeName").placeholder = (currentUser.lang === "th") ? "‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" : "Food name";
  document.getElementById("intakeCal").placeholder = (currentUser.lang === "th") ? "‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ" : "Calories";
  setText("btnAddIntake", t("addIntake"));
  setText("t_today_log", t("todayLog"));
  setText("t_history_title", t("historyTitle"));
  setText("btnSaveManualGoal", t("saveGoal"));
  document.getElementById("manualGoal").placeholder = (currentUser.lang === "th")
    ? "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤ kcal/‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 1800)"
    : "Set goal kcal/day (e.g., 1800)";
  setText("t_calorie_note", `${t("calorieNote")}\n${t("noMedical")}`);

  setText("t_workout_title", t("workoutTitle"));
  setText("btnGenWorkout", t("genWorkout"));
  setText("btnRegenWorkout", t("regenWorkout"));
  setText("t_workout_ai_disclaimer", `${t("noMedical")} ‚Ä¢ ${t("appStudy")}`);
  setText("t_edit_title", t("editTitle"));
  setText("btnSaveNotes", t("saveNotes"));

  setText("t_profile_title", t("profileTitle"));
  setText("t_profile_goal", t("profileGoal"));
  setText("btnSaveProfile", t("saveProfile"));
  setText("t_profile_disclaimer", t("profileDisc"));

  setText("t_settings_title", t("settingsTitle"));
  setText("t_lang_label", t("langLabel"));
  setText("btnReplayTutorial", t("replayTut"));
  setText("t_settings_disclaimer", `${t("settingsDisc")}\n${t("appStudy")}`);
  setText("t_admin_hint_title", t("adminHintTitle"));
  setText("t_admin_hint_body", t("adminHintBody"));
  setText("t_admin_longpress", t("longPress"));

  // logout buttons
  document.getElementById("btnLogout").innerText = t("logout");
  document.getElementById("btnLogoutTop").innerText = t("logout");
  document.getElementById("btnAdminLogout").innerText = t("logout");
  document.getElementById("btnAdminLogoutTop").innerText = t("logout");

  // admin
  const adminDisc = document.getElementById("t_admin_disclaimer");
  if(adminDisc) adminDisc.innerText = `${t("adminDis")}\n${t("appStudy")}`;
  setText("t_admin_rules", t("adminRules"));
  if(adminSearch){
    adminSearch.placeholder = (currentUser?.lang === "th") ? "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ user/email/lang/goal..." : "Search user/email/lang/goal...";
  }

  tutorialDisclaimer.innerText = `‚Äú${t("appStudy")}‚Äù`;
}

/* language switch */
function changeLanguage(lang){
  if(!currentUser){ setUiLang(lang); applyStaticI18n(lang); return; }
  currentUser.lang = lang;
  setUiLang(lang);
  save();
  applyAppI18n();
  topLang.innerText = `Language: ${currentUser.lang.toUpperCase()}`;

  if(!screenHome.classList.contains("hide")) renderHome();
  if(!screenFood.classList.contains("hide")) renderFood();
  if(!screenWorkout.classList.contains("hide")) renderWorkout();
  if(!screenProfile.classList.contains("hide")) renderProfile();
  if(currentUser.role === "admin") renderAdmin();
}

/* =========================================================
   Tabs
========================================================= */
function goTab(tab, silent=false){
  screenHome.classList.add("hide");
  screenFood.classList.add("hide");
  screenWorkout.classList.add("hide");
  screenProfile.classList.add("hide");
  screenSettings.classList.add("hide");

  ["Home","Food","Workout","Profile","Settings"].forEach(x=>{
    document.getElementById("tab"+x).classList.remove("active");
  });

  if(tab === "home"){ screenHome.classList.remove("hide"); document.getElementById("tabHome").classList.add("active"); renderHome(); }
  if(tab === "food"){ screenFood.classList.remove("hide"); document.getElementById("tabFood").classList.add("active"); renderFood(); }
  if(tab === "workout"){ screenWorkout.classList.remove("hide"); document.getElementById("tabWorkout").classList.add("active"); renderWorkout(); }
  if(tab === "profile"){ screenProfile.classList.remove("hide"); document.getElementById("tabProfile").classList.add("active"); renderProfile(); }
  if(tab === "settings"){ screenSettings.classList.remove("hide"); document.getElementById("tabSettings").classList.add("active"); }

  if(!silent) clearHighlight();
}

/* =========================================================
   Calorie target (simple estimate)
========================================================= */
function calcTargetCalories(user){
  const w = Number(user.weight || 0);
  const h = Number(user.height || 0);
  const a = Number(user.age || 0);
  if(!w || !h || !a) return 2000;

  const s = (user.gender === "male") ? 5 : (user.gender === "female") ? -161 : -78;
  const bmr = (10*w) + (6.25*h) - (5*a) + s;
  let tdee = bmr * 1.35;

  if(user.goal === "lose") tdee -= 400;
  if(user.goal === "gain") tdee += 300;

  return Math.max(1200, Math.round(tdee));
}

function ensureTodayHistory(){
  const d = todayKey();
  if(!currentUser.history) currentUser.history = {};
  if(!currentUser.history[d]){
    currentUser.history[d] = {
      target: calcTargetCalories(currentUser),
      manualGoal: null,
      meals: null,
      intakes: [],
      intakeTotal: 0
    };
    save();
  } else {
    currentUser.history[d].target = calcTargetCalories(currentUser);
    if(!Array.isArray(currentUser.history[d].intakes)) currentUser.history[d].intakes = [];
    currentUser.history[d].intakeTotal = currentUser.history[d].intakes.reduce((s,x)=>s+Number(x.cal||0),0);
    save();
  }
}

function getTodayDay(){
  ensureTodayHistory();
  return currentUser.history[todayKey()];
}

/* =========================================================
   Home
========================================================= */
function renderHome(){
  const day = getTodayDay();

  const badges = [];
  badges.push(`<span class="pill">üß© ${currentUser.role.toUpperCase()}</span>`);
  badges.push(`<span class="pill">üåê ${currentUser.lang.toUpperCase()}</span>`);
  badges.push(`<span class="pill">üéØ ${(currentUser.goal || "maintain").toUpperCase()}</span>`);
  document.getElementById("homeBadges").innerHTML = badges.join("");

  const target = (day.manualGoal != null) ? day.manualGoal : day.target;
  const intake = day.intakeTotal || 0;
  const remain = target - intake;

  const remainText = (remain >= 0)
    ? `${remain}`
    : (currentUser.lang === "th" ? `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remain)}` : `Over ${Math.abs(remain)}`);

  document.getElementById("homeOverview").innerHTML = `
    <table>
      <tr><th>${t("calTarget")}</th><th>${t("calIntake")}</th><th>${t("calRemaining")}</th></tr>
      <tr><td>${target}</td><td>${intake}</td><td>${remainText}</td></tr>
    </table>
    <div class="disclaimer">${t("noMedical")} ‚Ä¢ ${t("appStudy")}</div>
  `;
}

/* =========================================================
   Food & Calories
========================================================= */
function renderFood(){
  const day = getTodayDay();

  const target = (day.manualGoal != null) ? day.manualGoal : day.target;
  const intake = day.intakeTotal || 0;
  const remain = target - intake;
  const remainText = (remain >= 0)
    ? `${remain}`
    : (currentUser.lang === "th" ? `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(remain)}` : `Over ${Math.abs(remain)}`);

  calorieSummary.innerHTML = `
    <table>
      <tr><th>${t("calTarget")}</th><th>${t("calIntake")}</th><th>${t("calRemaining")}</th></tr>
      <tr><td>${target}</td><td>${intake}</td><td>${remainText}</td></tr>
    </table>
  `;

  // meals
  if(day.meals){
    aiMealTable.innerHTML = renderMealTable(day.meals);
  } else {
    aiMealTable.innerHTML = `<div class="muted">${t("mealPlanTitle")} ‚Äî ${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á":"not generated yet"}</div>`;
  }

  // manual goal input
  document.getElementById("manualGoal").value = (day.manualGoal ?? "");

  renderTodayIntakeLog();
  renderHistory();
}

function renderMealTable(meals){
  let total = meals.reduce((s,m)=>s+m.cal,0);
  const rows = meals.map(m => `
    <tr>
      <td>${m.time}</td>
      <td>${m.name}</td>
      <td>${m.cal}</td>
    </tr>
  `).join("");

  return `
    <h3 style="margin-top:12px">${t("mealPlanTitle")}</h3>
    <table>
      <tr><th>${t("time")}</th><th>${t("meal")}</th><th>${t("calories")}</th></tr>
      ${rows}
      <tr><th colspan="2">${t("total")}</th><th>${total}</th></tr>
    </table>
    <div class="disclaimer">${t("noMedical")}</div>
  `;
}

function generateMeals(){
  const day = getTodayDay();
  const goal = currentUser.goal || "maintain";
  const lang = currentUser.lang;

  const foodsEN = {
    protein: ["Chicken breast", "Salmon", "Eggs", "Tofu", "Greek yogurt"],
    carbs: ["Rice", "Oats", "Sweet potato", "Whole-wheat bread", "Quinoa"],
    veg: ["Salad", "Broccoli", "Mixed vegetables", "Spinach", "Tomato soup"],
    snack: ["Banana", "Nuts", "Apple", "Protein bar", "Milk"]
  };
  const foodsTH = {
    protein: ["‡∏≠‡∏Å‡πÑ‡∏Å‡πà", "‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô", "‡πÑ‡∏Ç‡πà", "‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ", "‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï‡∏Å‡∏£‡∏µ‡∏Å"],
    carbs: ["‡∏Ç‡πâ‡∏≤‡∏ß", "‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï", "‡∏°‡∏±‡∏ô‡∏´‡∏ß‡∏≤‡∏ô", "‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ï", "‡∏Ñ‡∏ß‡∏¥‡∏ô‡∏±‡∏ß"],
    veg: ["‡∏™‡∏•‡∏±‡∏î", "‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ", "‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏°", "‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°", "‡∏ã‡∏∏‡∏õ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®"],
    snack: ["‡∏Å‡∏•‡πâ‡∏ß‡∏¢", "‡∏ñ‡∏±‡πà‡∏ß", "‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•", "‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ö‡∏≤‡∏£‡πå", "‡∏ô‡∏°"]
  };
  const F = (lang === "th") ? foodsTH : foodsEN;

  const base = (goal === "lose") ? 1600 : (goal === "gain") ? 2400 : 2000;
  const mealSplit = {
    [t("breakfast")]: 0.28,
    [t("lunch")]: 0.34,
    [t("dinner")]: 0.28,
    [t("snack")]: 0.10
  };

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function calFor(frac){
    const v = Math.round(base*frac + (Math.random()*90 - 45));
    return Math.max(80, v);
  }

  const meals = [
    { time: t("breakfast"), name: `${pick(F.protein)} + ${pick(F.carbs)}`, cal: calFor(mealSplit[t("breakfast")]) },
    { time: t("lunch"), name: `${pick(F.protein)} + ${pick(F.veg)} + ${pick(F.carbs)}`, cal: calFor(mealSplit[t("lunch")]) },
    { time: t("dinner"), name: `${pick(F.protein)} + ${pick(F.veg)}`, cal: calFor(mealSplit[t("dinner")]) },
    { time: t("snack"), name: `${pick(F.snack)}`, cal: calFor(mealSplit[t("snack")]) }
  ];

  day.meals = meals;
  save();
  renderFood();
}

function addIntake(){
  const lang = currentUser.lang;
  const name = document.getElementById("intakeName").value.trim();
  const cal = Number(document.getElementById("intakeCal").value || 0);
  if(!name || !cal){ alert(I18N[lang].errIntake); return; }

  const day = getTodayDay();
  day.intakes.unshift({ name, cal, ts: Date.now() });
  day.intakeTotal = day.intakes.reduce((s,x)=>s+Number(x.cal||0),0);

  document.getElementById("intakeName").value = "";
  document.getElementById("intakeCal").value = "";

  save();
  renderFood();
}

function quickAdd(kcal){
  const name = document.getElementById("intakeName").value.trim() || (currentUser.lang==="th" ? "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πà‡∏ß‡∏ô" : "Quick Add");
  document.getElementById("intakeCal").value = kcal;
  document.getElementById("intakeName").value = name;
  addIntake();
}

function deleteIntake(index){
  const day = getTodayDay();
  day.intakes.splice(index, 1);
  day.intakeTotal = day.intakes.reduce((s,x)=>s+Number(x.cal||0),0);
  save();
  renderFood();
}

function renderTodayIntakeLog(){
  const day = getTodayDay();
  const list = day.intakes || [];

  if(!list.length){
    intakeLogTable.innerHTML = `<p style="text-align:center">${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ":"No intake yet today"}</p>`;
    return;
  }

  let html = `<table>
    <tr>
      <th>${currentUser.lang==="th"?"‡πÄ‡∏ß‡∏•‡∏≤":"Time"}</th>
      <th>${currentUser.lang==="th"?"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£":"Item"}</th>
      <th>kcal</th>
      <th>${currentUser.lang==="th"?"‡∏•‡∏ö":"Del"}</th>
    </tr>`;

  list.forEach((it, idx) => {
    const time = new Date(it.ts).toLocaleTimeString(currentUser.lang==="th"?"th-TH":"en-US",{hour:"2-digit",minute:"2-digit"});
    html += `<tr>
      <td>${time}</td>
      <td style="text-align:left">${escapeHtml(it.name)}</td>
      <td>${Number(it.cal||0)}</td>
      <td><button class="red" style="margin:0;padding:8px 10px;border-radius:14px;box-shadow:none" onclick="deleteIntake(${idx})">
        ${currentUser.lang==="th"?"‡∏•‡∏ö":"Delete"}
      </button></td>
    </tr>`;
  });

  html += `</table>`;
  intakeLogTable.innerHTML = html;
}

function saveManualGoal(){
  const lang = currentUser.lang;
  const v = document.getElementById("manualGoal").value.trim();
  const day = getTodayDay();

  if(v === ""){
    day.manualGoal = null;
    save();
    renderFood();
    return;
  }

  const n = Number(v);
  if(!Number.isFinite(n) || n <= 0){ alert(I18N[lang].errGoal); return; }
  day.manualGoal = Math.round(n);
  save();
  renderFood();
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function renderHistory(){
  const keys = Object.keys(currentUser.history || {}).sort().slice(-10).reverse();
  let html = `<table><tr><th>${currentUser.lang==="th"?"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà":"Date"}</th><th>${t("calTarget")}</th><th>${t("calIntake")}</th></tr>`;

  for(const k of keys){
    const day = currentUser.history[k];
    const target = (day.manualGoal != null) ? day.manualGoal : (day.target || "-");
    html += `<tr><td>${k}</td><td>${target}</td><td>${day.intakeTotal || 0}</td></tr>`;
  }
  html += `</table>`;
  historyTable.innerHTML = html;
}

/* =========================================================
   Workout generator (mock AI)
========================================================= */
function renderWorkout(){
  if(currentUser.workoutPlan){
    workoutPlan.innerHTML = renderWorkoutPlan(currentUser.workoutPlan);
  } else {
    workoutPlan.innerHTML = `<div class="muted">${t("weeklyPlan")} ‚Äî ${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á":"not generated yet"}</div>`;
  }
  workoutNotes.value = currentUser.workoutNotes || "";
}

function generateWorkout(){
  const level = document.getElementById("wLevel").value;
  const goal = document.getElementById("wGoal").value;
  const days = Number(document.getElementById("wDays").value);
  const equip = document.getElementById("wEquip").value;
  const lang = currentUser.lang;

  const ex = {
    gym: {
      upper: lang==="th" ? ["‡∏î‡∏±‡∏ô‡∏≠‡∏Å‡πÅ‡∏°‡∏ä‡∏ä‡∏µ‡∏ô","Lat Pulldown","‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•‡∏ä‡∏≠‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏£‡∏™","‡πÄ‡∏Ñ‡πÄ‡∏ö‡∏¥‡∏•‡πÇ‡∏£‡∏ß‡πå","‡πÑ‡∏ó‡∏£‡πÄ‡∏ã‡πá‡∏õ‡∏™‡πå‡∏Å‡∏î‡∏•‡∏á"] : ["Chest press machine","Lat pulldown","DB shoulder press","Cable row","Triceps pushdown"],
      lower: lang==="th" ? ["‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó","‡πÄ‡∏•‡∏Å‡πÄ‡∏û‡∏£‡∏™","RDL","‡πÄ‡∏•‡∏Å‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡πÄ‡∏ó‡∏ô‡∏ä‡∏±‡∏ô","‡πÅ‡∏Æ‡∏°‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏Ñ‡∏π‡∏•"] : ["Squat","Leg press","RDL","Leg extension","Hamstring curl"],
      cardio: lang==="th" ? ["‡πÄ‡∏î‡∏¥‡∏ô‡∏ä‡∏±‡∏ô 20 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ"] : ["Incline walk 20 min","Bike 15 min"]
    },
    home: {
      upper: lang==="th" ? ["‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô","‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•‡πÇ‡∏£‡∏ß‡πå","‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•‡∏ä‡∏≠‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏£‡∏™","‡πÑ‡∏ö‡πÄ‡∏ã‡πá‡∏õ‡∏™‡πå‡πÄ‡∏Ñ‡∏¥‡∏£‡πå‡∏•","‡∏ó‡∏£‡∏¥‡πÄ‡∏ã‡πá‡∏õ‡∏™‡πå‡∏î‡∏¥‡∏õ"] : ["Push-ups","DB rows","DB shoulder press","Biceps curl","Triceps dips"],
      lower: lang==="th" ? ["‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß","‡∏•‡∏±‡∏ô‡∏à‡πå","‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏Å‡πâ‡∏ô (Glute bridge)","‡πÄ‡∏î‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•","‡∏Ñ‡∏≤‡∏•‡πå‡∏ü‡πÄ‡∏£‡∏™"] : ["Bodyweight squats","Lunges","Glute bridge","DB deadlift","Calf raises"],
      cardio: lang==="th" ? ["‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ï‡∏ö 10 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 12 ‡∏ô‡∏≤‡∏ó‡∏µ"] : ["Jumping jacks 10 min","High knees 12 min"]
    },
    none: {
      upper: lang==="th" ? ["‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô","‡πÅ‡∏û‡∏•‡∏á‡∏Å‡πå‡πÑ‡∏´‡∏•‡πà‡πÅ‡∏ï‡∏∞","‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô","‡∏≠‡∏¥‡∏ô‡∏ä‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏°"] : ["Push-ups","Plank shoulder taps","Diamond push-ups","Inchworms"],
      lower: lang==="th" ? ["‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó","‡∏•‡∏±‡∏ô‡∏à‡πå","‡∏ß‡∏≠‡∏•‡∏•‡πå‡∏ã‡∏¥‡∏ó","‡∏Å‡∏•‡∏π‡∏ï‡∏ö‡∏£‡∏¥‡∏î‡∏à‡πå"] : ["Squats","Lunges","Wall sit","Glute bridge"],
      cardio: lang==="th" ? ["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏µ 8 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 10 ‡∏ô‡∏≤‡∏ó‡∏µ"] : ["Burpees 8 min","High knees 10 min"]
    }
  };

  const difficulty = {
    beginner: { sets: 3, reps: "10-12", rest: 60 },
    intermediate: { sets: 4, reps: "8-12", rest: 75 },
    advanced: { sets: 5, reps: "6-10", rest: 90 }
  }[level];

  function pick(arr){
    const copy = [...arr];
    copy.sort(()=>Math.random()-0.5);
    return copy.slice(0, Math.min(4, copy.length));
  }

  const plan = [];
  for(let i=1;i<=days;i++){
    const isUpper = (i % 2 === 1);
    const group = isUpper ? "upper" : "lower";

    const main = pick(ex[equip][group]).map(name => ({
      name, sets: difficulty.sets, reps: difficulty.reps, rest: difficulty.rest
    }));

    const cardio = (goal === "fatloss" || goal === "general")
      ? pick(ex[equip].cardio).map(name => ({ name, sets: 1, reps: lang==="th" ? "‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤" : "time-based", rest: 0 }))
      : [];

    plan.push({
      day: (lang==="th" ? `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${i}` : `Day ${i}`),
      focus: isUpper ? (lang==="th" ? "‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô" : "Upper") : (lang==="th" ? "‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á" : "Lower"),
      items: [...main, ...cardio]
    });
  }

  currentUser.workoutPlan = { level, goal, days, equip, createdAt: Date.now(), plan };
  save();
  renderWorkout();
}

function renderWorkoutPlan(wp){
  let html = `<h3 style="margin-top:12px">${t("weeklyPlan")}</h3>`;
  html += `<div class="muted" style="margin-bottom:10px">
    ${currentUser.lang==="th" ? "‡∏£‡∏∞‡∏î‡∏±‡∏ö" : "Level"}: <b>${wp.level}</b> ‚Ä¢
    ${currentUser.lang==="th" ? "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢" : "Goal"}: <b>${wp.goal}</b> ‚Ä¢
    ${currentUser.lang==="th" ? "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" : "Equipment"}: <b>${wp.equip}</b> ‚Ä¢
    ${currentUser.lang==="th" ? "‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå" : "Days/week"}: <b>${wp.days}</b>
  </div>`;

  wp.plan.forEach(d => {
    html += `<div class="card" style="margin:10px 0;padding:12px;border-radius:18px;box-shadow:0 10px 22px rgba(0,0,0,.28)">
      <div style="font-weight:900;margin-bottom:6px">${d.day} ‚Äî ${d.focus}</div>
      <table>
        <tr><th>${t("exercise")}</th><th>${t("sets")}</th><th>${t("reps")}</th><th>${t("rest")}</th></tr>
        ${d.items.map(it => `
          <tr>
            <td style="text-align:left">${escapeHtml(it.name)}</td>
            <td>${it.sets}</td>
            <td>${it.reps}</td>
            <td>${it.rest ? (it.rest + " " + t("seconds")) : "-"}</td>
          </tr>
        `).join("")}
      </table>
    </div>`;
  });

  return html;
}

function saveWorkoutNotes(){
  currentUser.workoutNotes = workoutNotes.value;
  save();
  alert(currentUser.lang==="th" ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "Saved ‚úÖ");
}

/* =========================================================
   Profile
========================================================= */
function renderProfile(){
  const u = currentUser;
  document.getElementById("profileGoal").value = u.goal || "maintain";
  document.getElementById("profileInfo").innerHTML = `
    <table>
      <tr><th>User ID</th><td>${u.id}</td></tr>
      <tr><th>Username</th><td>${escapeHtml(u.user)}</td></tr>
      <tr><th>Email</th><td>${escapeHtml(u.email)}</td></tr>
      <tr><th>${u.lang==="th"?"‡∏ä‡∏∑‡πà‡∏≠":"Name"}</th><td>${escapeHtml(u.name)} ${escapeHtml(u.lname||"")}</td></tr>
      <tr><th>${u.lang==="th"?"‡∏≠‡∏≤‡∏¢‡∏∏":"Age"}</th><td>${u.age||0}</td></tr>
      <tr><th>${u.lang==="th"?"‡πÄ‡∏û‡∏®":"Gender"}</th><td>${escapeHtml(u.gender||"-")}</td></tr>
      <tr><th>${u.lang==="th"?"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å":"Weight"}</th><td>${u.weight||0}</td></tr>
      <tr><th>${u.lang==="th"?"‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á":"Height"}</th><td>${u.height||0}</td></tr>
      <tr><th>${u.lang==="th"?"‡∏†‡∏≤‡∏©‡∏≤":"Language"}</th><td>${String(u.lang||"en").toUpperCase()}</td></tr>
    </table>
  `;
}

function saveProfile(){
  const newGoal = document.getElementById("profileGoal").value;
  currentUser.goal = newGoal;

  // update target for today
  ensureTodayHistory();
  save();

  alert(currentUser.lang==="th" ? "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "Profile updated ‚úÖ");
  renderProfile();
  renderHome();
  renderFood();
}

/* =========================================================
   Admin (Read-only + Search)
========================================================= */
function renderAdmin(){
  const q = (adminSearch?.value || "").trim().toLowerCase();

  const userList = users.filter(u => u.role === "user");
  const totalUsers = userList.length;
  const langs = userList.reduce((acc,u)=>{ acc[u.lang]= (acc[u.lang]||0)+1; return acc; }, {});
  const langList = Object.keys(langs).map(k=>`${k.toUpperCase()}:${langs[k]}`).join(" ‚Ä¢ ");

  adminStats.innerHTML = `
    <div class="disclaimer" id="adminStats">
      <b>${currentUser.lang==="th"?"‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏£‡∏∏‡∏õ":"Summary"}</b><br/>
      ${currentUser.lang==="th"?"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ":"Users"}: <b>${totalUsers}</b><br/>
      ${currentUser.lang==="th"?"‡∏†‡∏≤‡∏©‡∏≤":"Languages"}: <b>${langList || "-"}</b><br/>
      <div style="margin-top:8px">${t("adminDis")}</div>
    </div>
  `;

  const filtered = q ? userList.filter(u =>
    (u.id||"").toLowerCase().includes(q) ||
    (u.user||"").toLowerCase().includes(q) ||
    (u.email||"").toLowerCase().includes(q) ||
    (u.lang||"").toLowerCase().includes(q) ||
    (u.goal||"").toLowerCase().includes(q)
  ) : userList;

  let table = `<table>
    <tr>
      <th>User ID</th>
      <th>Username</th>
      <th>Email</th>
      <th>Lang</th>
      <th>Goal</th>
    </tr>`;

  filtered.forEach(u=>{
    table += `<tr>
      <td>${escapeHtml(u.id)}</td>
      <td>${escapeHtml(u.user)}</td>
      <td>${escapeHtml(u.email)}</td>
      <td>${String(u.lang||"en").toUpperCase()}</td>
      <td>${escapeHtml(u.goal||"maintain")}</td>
    </tr>`;
  });
  table += `</table>`;
  adminData.innerHTML = table;
}

/* =========================================================
   Tutorials
========================================================= */
let tutorialMode = null; // "user" | "admin"
let tutorialIndex = 0;

function clearHighlight(){
  document.querySelectorAll(".highlight").forEach(el => el.classList.remove("highlight"));
}
function applyHighlight(targetId){
  clearHighlight();
  if(!targetId) return;
  const el = document.getElementById(targetId);
  if(el) el.classList.add("highlight");
}
function openTutorial(){ tutorialOverlay.classList.remove("hide"); }
function closeTutorial(){ tutorialOverlay.classList.add("hide"); clearHighlight(); }

function startUserTutorial(forceReplay=false){
  if(!currentUser || currentUser.role !== "user") return;
  if(!forceReplay && currentUser.firstLaunchDone) return;
  tutorialMode = "user";
  tutorialIndex = 0;
  openTutorial();
  renderTutorialStep();
}

function startAdminTutorial(forceReplay=false){
  if(!currentUser || currentUser.role !== "admin") return;
  if(!forceReplay && currentUser.firstAdminTutDone) return;
  tutorialMode = "admin";
  tutorialIndex = 0;
  openTutorial();
  renderTutorialStep();
}

function renderTutorialStep(){
  const steps = (tutorialMode === "admin") ? I18N[currentUser.lang].tutAdminSteps : I18N[currentUser.lang].tutUserSteps;
  const s = steps[tutorialIndex];

  tutorialStepLabel.innerText = s.step;
  tutorialTitle.innerText = s.title;
  tutorialBody.innerText = s.body;
  tutorialDisclaimer.innerText = `‚Äú${t("appStudy")}‚Äù`;

  btnTutorialBack.disabled = tutorialIndex === 0;

  const isLast = tutorialIndex === steps.length - 1;
  btnTutorialNext.innerText = isLast ? (currentUser.lang==="th" ? "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "Start Using App") : (currentUser.lang==="th" ? "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" : "Next");
  btnTutorialSkip.innerText = currentUser.lang==="th" ? "‡∏Ç‡πâ‡∏≤‡∏°" : "Skip";

  if(tutorialMode === "user"){
    if(s.highlight === "tabFood") goTab("food", true);
    if(s.highlight === "tabWorkout") goTab("workout", true);
    if(s.highlight === "tabSettings") goTab("settings", true);
  }
  applyHighlight(s.highlight);
}

function tutorialNext(){
  const steps = (tutorialMode === "admin") ? I18N[currentUser.lang].tutAdminSteps : I18N[currentUser.lang].tutUserSteps;
  if(tutorialIndex < steps.length - 1){
    tutorialIndex++;
    renderTutorialStep();
    return;
  }
  if(tutorialMode === "user") currentUser.firstLaunchDone = true;
  if(tutorialMode === "admin") currentUser.firstAdminTutDone = true;
  save();
  closeTutorial();
  if(tutorialMode === "user") goTab("home", true);
}
function tutorialBack(){
  if(tutorialIndex <= 0) return;
  tutorialIndex--;
  renderTutorialStep();
}
function tutorialSkip(){
  if(tutorialMode === "user") currentUser.firstLaunchDone = true;
  if(tutorialMode === "admin") currentUser.firstAdminTutDone = true;
  save();
  closeTutorial();
  if(tutorialMode === "user") goTab("home", true);
}

/* =========================================================
   Hidden Admin Access (Long-press on Settings title)
========================================================= */
let pressTimer = null;
function bindLongPressAdminHint(){
  const title = document.getElementById("t_settings_title");
  if(!title) return;

  const start = () => {
    pressTimer = setTimeout(() => {
      alert(currentUser.lang==="th"
        ? "‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ: ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ admin (username: admin / password: admin123) ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Login"
        : "Hint: Use admin account (username: admin / password: admin123) at Login"
      );
    }, 1200);
  };
  const end = () => { if(pressTimer) clearTimeout(pressTimer); pressTimer = null; };

  title.addEventListener("touchstart", start);
  title.addEventListener("touchend", end);
  title.addEventListener("touchcancel", end);

  title.addEventListener("mousedown", start);
  title.addEventListener("mouseup", end);
  title.addEventListener("mouseleave", end);
}

/* =========================================================
   Auto login (Remember me)
========================================================= */
function tryAutoLogin(){
  const remembered = localStorage.getItem(LS_SESSION_USER);
  if(!remembered) return false;
  const u = users.find(x => x.user.toLowerCase() === remembered.toLowerCase());
  if(!u) return false;

  currentUser = u;
  currentUser.online = true;
  setUiLang(currentUser.lang);
  save();

  hideAll();
  if(currentUser.role === "admin"){
    adminBox.classList.remove("hide");
    adminLang.innerText = `Language: ${currentUser.lang.toUpperCase()}`;
    applyAppI18n();
    renderAdmin();
    startAdminTutorial(false);
  } else {
    appBox.classList.remove("hide");
    bottomNav.classList.remove("hide");
    bootUserApp();
  }
  return true;
}

/* =========================================================
   Init
========================================================= */
(function init(){
  // default language before login
  applyStaticI18n(getUiLang());

  // wire admin search
  if(adminSearch){
    adminSearch.addEventListener("input", () => {
      if(currentUser && currentUser.role === "admin") renderAdmin();
    });
  }

  // attempt auto login
  if(!tryAutoLogin()){
    showRegister(); // or showLogin()
  }

  // bind long press hint (works when settings screen exists)
  bindLongPressAdminHint();
})();
</script>

</body>
</html>
