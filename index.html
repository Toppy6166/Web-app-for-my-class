<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>FitSense AI ‚Äì Fitness & Nutrition (Study Case)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --p:#6C63FF;        /* Primary (AI Tech) */
      --s:#00C9A7;        /* Secondary (Health) */
      --a:#FFB020;        /* Accent */
      --bg1:#F3F4FF;
      --bg2:#E9FFF8;
      --ink:#22253a;
      --muted:rgba(34,37,58,.72);
      --card:#ffffffee;
      --stroke:rgba(0,0,0,.08);
      --danger:#E94B4B;
    }

    *{box-sizing:border-box;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      padding-bottom:92px; /* bottom nav space */
      color:var(--ink);
    }
    .hide{display:none!important}

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:18px 14px;
    }

    /* Top brand */
    .brand{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:10px auto 0;
      max-width:980px;
      padding:0 14px;
    }
    .logo{
      display:flex;align-items:center;gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .dot{
      width:14px;height:14px;border-radius:999px;background:var(--p);
      box-shadow:0 8px 24px rgba(108,99,255,.35);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:#fff; border:1px solid var(--stroke);
      font-size:12px;color:var(--muted)
    }

    /* Card */
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(8px);
      max-width:560px;
      margin:14px auto;
      padding:18px;
      border-radius:22px;
      box-shadow:0 18px 40px rgba(0,0,0,.10);
    }
    h2,h3{margin:8px 0 10px}
    h2{font-size:22px;text-align:center;color:var(--p)}
    h3{font-size:16px}
    p{line-height:1.5;margin:8px 0}
    small{color:var(--muted)}

    /* Inputs */
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      outline:none;
      margin:6px 0;
      color:var(--ink);
    }
    textarea{min-height:92px;resize:vertical}

    /* Buttons */
    button{
      width:100%;
      padding:13px 12px;
      border:none;
      border-radius:16px;
      cursor:pointer;
      font-weight:700;
      margin-top:10px;
      transition:transform .08s ease, opacity .1s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    button:active{transform:translateY(2px)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .bP{background:var(--p);color:#fff}
    .bS{background:var(--s);color:#fff}
    .bA{background:var(--a);color:#1b1b1b}
    .bG{background:#9aa0aa;color:#fff}
    .bD{background:var(--danger);color:#fff}
    .bO{
      background:transparent;
      border:2px solid var(--p);
      color:var(--p);
      box-shadow:none;
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){ .row{grid-template-columns:1fr} }

    /* Mini header in app */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .who{font-weight:800}
    .subbar{font-size:12px;color:var(--muted)}

    /* Dashboard cards */
    .grid4{
      display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
    }
    @media(max-width:820px){ .grid4{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:12px;border-radius:18px;background:#fff;
      border:1px solid var(--stroke);
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:700}
    .kpi .val{font-size:20px;font-weight:900;margin-top:4px}
    .kpi .hint{font-size:11px;color:var(--muted);margin-top:4px}
    .kpi.p{border-left:6px solid var(--p)}
    .kpi.s{border-left:6px solid var(--s)}
    .kpi.a{border-left:6px solid var(--a)}
    .kpi.d{border-left:6px solid var(--danger)}

    .section{
      margin-top:12px;
      padding:12px;
      border-radius:18px;
      background:rgba(255,255,255,.75);
      border:1px solid var(--stroke);
    }

    table{width:100%;border-collapse:collapse;font-size:13px;border-radius:14px;overflow:hidden}
    th,td{border:1px solid rgba(0,0,0,.10);padding:8px;text-align:center}
    th{background:rgba(0,0,0,.04);font-weight:800}

    .disclaimer{
      font-size:12px;
      padding:10px;
      border-radius:14px;
      background:rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.06);
      white-space:pre-line;
      margin-top:10px;
      color:var(--muted);
    }

    /* Bottom nav */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(12px);
      border-top:1px solid rgba(0,0,0,.10);
      padding:10px 10px 16px;
      z-index:999;
    }
    .nav-wrap{
      max-width:980px;margin:0 auto;
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px;
    }
    .tab{
      border-radius:16px;
      padding:10px 6px;
      text-align:center;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(0,0,0,.03);
      font-weight:800;
    }
    .tab.active{
      background:var(--p);
      color:#fff;
      border-color:var(--p);
      box-shadow:0 12px 26px rgba(108,99,255,.28);
    }

    /* Modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:16px;z-index:9999;
    }
    .modal{
      width:100%;
      max-width:640px;
      background:#fff;border-radius:22px;
      padding:16px;
      box-shadow:0 20px 50px rgba(0,0,0,.35);
    }
    .modalTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .modalTitle{font-weight:900;color:var(--p)}
    .xBtn{width:auto;padding:10px 12px;border-radius:14px}

    /* Tutorial */
    .tStep{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.06);font-weight:900}
    .highlight{outline:3px solid rgba(255,176,32,.95);outline-offset:3px;border-radius:14px}

    /* Admin terminal look */
    .adminBox{
      background:#0f1222;color:#d8defa;
      border-radius:18px;padding:12px;border:1px solid rgba(255,255,255,.10);
      overflow:auto;max-height:420px;font-size:12px;
    }
    .adminBox table{font-size:12px}
    .adminBox th{background:rgba(255,255,255,.06);color:#fff;border-color:rgba(255,255,255,.12)}
    .adminBox td{border-color:rgba(255,255,255,.12)}
  </style>
</head>

<body>

  <div class="brand">
    <div class="logo"><span class="dot"></span> FitSense AI</div>
    <div class="pill" id="topPill">Study Case ‚Ä¢ LocalStorage</div>
  </div>

  <!-- ================= AUTH ================= -->
  <div class="card" id="registerBox">
    <div class="topbar">
      <div>
        <div class="who" id="t_reg_title"> Register</div>
        <div class="subbar" id="t_reg_sub">Create your profile to get AI suggestions</div>
      </div>
      <select id="regLangSwitch" style="width:auto" onchange="setUiLang(this.value); applyStaticI18n();">
        <option value="en">ENG</option>
        <option value="th">TH</option>
      </select>
    </div>

    <div class="row">
      <input id="rUser" placeholder="Username (‚â• 3 chars)" autocomplete="username">
      <input id="rEmail" placeholder="Email" autocomplete="email">
    </div>
    <input id="rPass" type="password" placeholder="Password (‚â• 6 + special char)" autocomplete="new-password">

    <div class="row">
      <input id="rName" placeholder="First name">
      <input id="rLname" placeholder="Last name">
    </div>

    <div class="row">
      <input id="rAge" type="number" placeholder="Age">
      <select id="rGender">
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
    </div>

    <div class="row">
      <input id="rWeight" type="number" placeholder="Weight (kg)">
      <input id="rHeight" type="number" placeholder="Height (cm)">
    </div>

    <div class="row">
      <select id="rGoal">
        <option value="lose">Lose weight</option>
        <option value="maintain">Maintain</option>
        <option value="gain">Gain muscle</option>
      </select>
      <select id="rLang">
        <option value="en">English (ENG)</option>
        <option value="th">‡πÑ‡∏ó‡∏¢ (THA)</option>
      </select>
    </div>

    <button class="bP" id="btnRegister" onclick="register()">Register</button>
    <button class="bO" id="btnGoLogin" onclick="showLogin()" style="margin-top:10px">Go to Login</button>

    <div class="disclaimer" id="t_auth_disclaimer"></div>
  </div>

  <div class="card hide" id="loginBox">
    <div class="topbar">
      <div>
        <div class="who" id="t_login_title"> Login</div>
        <div class="subbar" id="t_login_sub">Welcome back</div>
      </div>
      <select id="loginLangSwitch" style="width:auto" onchange="setUiLang(this.value); applyStaticI18n();">
        <option value="en">ENG</option>
        <option value="th">TH</option>
      </select>
    </div>

    <input id="lUser" placeholder="Username" autocomplete="username">
    <input id="lPass" type="password" placeholder="Password" autocomplete="current-password">

    <label style="display:flex;align-items:center;gap:8px;margin-top:6px;color:var(--muted);font-size:13px">
      <input type="checkbox" id="rememberMe" style="width:auto;transform:scale(1.1);margin:0">
      <span id="t_remember">Remember me</span>
    </label>

    <button class="bP" id="btnLogin" onclick="login()">Login</button>
    <button class="bA" id="btnForgot" onclick="showForgot()">Forgot Password (OTP Email)</button>
    <button class="bO" id="btnGoRegister" onclick="showRegister()">Create new account</button>

    <div class="disclaimer" id="t_auth_disclaimer2"></div>
  </div>

  <div class="card hide" id="forgotBox">
    <div class="topbar">
      <div>
        <div class="who" id="t_forgot_title"> Reset password</div>
        <div class="subbar" id="t_forgot_sub">OTP will be sent to your email</div>
      </div>
      <select id="forgotLangSwitch" style="width:auto" onchange="setUiLang(this.value); applyStaticI18n();">
        <option value="en">ENG</option>
        <option value="th">TH</option>
      </select>
    </div>

    <input id="fEmail" placeholder="Email">
    <button class="bP" id="btnSendOTP" onclick="sendOTP()">Send OTP to Email</button>

    <div class="row">
      <input id="fOTP" placeholder="OTP">
      <input id="fNewPass" type="password" placeholder="New password (‚â• 6 + special char)">
    </div>

    <button class="bS" id="btnReset" onclick="resetPassword()">Reset Password</button>
    <button class="bO" id="btnCancelReset" onclick="showLogin()">Cancel</button>

    <div class="disclaimer" id="t_otp_disclaimer"></div>
  </div>

  <!-- ================= USER APP ================= -->
  <div class="wrap hide" id="appWrap">
    <div class="card" id="appBox">
      <div class="topbar">
        <div>
          <div class="who" id="welcome"></div>
          <div class="subbar" id="topLang"></div>
        </div>
        <button class="bO" style="width:auto;padding:10px 12px;border-radius:14px" id="btnLogoutTop" onclick="logout()">
          Logout
        </button>
      </div>

      <!-- Screens -->
      <div id="screenHome">
        <h3 id="t_home_title"> Home Dashboard</h3>

        <div class="grid4" id="homeKpis"></div>

        <div class="section" id="aiInsightBox"></div>

        <div class="section">
          <h3 style="margin:0 0 8px" id="t_today_tables"> Today Summary</h3>
          <div id="homeTables"></div>
        </div>

        <div class="disclaimer" id="t_home_disclaimer"></div>
      </div>

      <div id="screenFood" class="hide">
        <h3 id="t_food_title"> Food & Calories</h3>

        <div id="calorieSummary"></div>

        <button class="bP" id="btnGenMeals" onclick="generateMeals()">Generate AI Meals</button>
        <div class="disclaimer" id="t_ai_disclaimer"></div>
        <div id="aiMealTable"></div>

        <h3 id="t_intake_title"> Log Intake</h3>
        <div class="section">
          <div class="row">
            <input id="intakeName" placeholder="Food name">
            <input id="intakeCal" type="number" placeholder="Calories">
          </div>
          <div class="row">
            <button class="bS" id="btnAddIntake" onclick="addIntake()">Add</button>
            <button class="bO" onclick="quickAdd(200)">+200</button>
          </div>
          <div class="row">
            <button class="bO" onclick="quickAdd(500)">+500</button>
            <button class="bO" onclick="quickAdd(800)">+800</button>
          </div>

          <div class="row" style="margin-top:8px">
            <input id="manualGoal" type="number" placeholder="Set calorie goal/day (e.g., 1800)">
            <button class="bO" id="btnSaveManualGoal" onclick="saveManualGoal()">Save goal</button>
          </div>

          <div class="disclaimer" id="t_calorie_note"></div>
        </div>

        <h3 id="t_today_log"> Today intake list</h3>
        <div id="intakeLogTable"></div>

        <h3 id="t_history_title"> Daily History</h3>
        <div id="historyTable"></div>
      </div>

      <div id="screenWorkout" class="hide">
        <h3 id="t_workout_title"> Workout + Calories Burned</h3>

        <div class="section">
          <h3 style="margin:0 0 8px" id="t_burn_title"> Log Workout (Burned Calories)</h3>
          <div class="row">
            <select id="wType">
              <option value="walk">Walking</option>
              <option value="run">Running</option>
              <option value="cycle">Cycling</option>
              <option value="weights">Weight training</option>
              <option value="hiit">HIIT</option>
            </select>
            <input id="wMinutes" type="number" placeholder="Minutes (e.g., 30)">
          </div>
          <div class="row">
            <select id="wIntensity">
              <option value="light">Light</option>
              <option value="moderate" selected>Moderate</option>
              <option value="hard">Hard</option>
            </select>
            <button class="bS" id="btnAddWorkoutLog" onclick="addWorkoutLog()">Add workout</button>
          </div>
          <div class="disclaimer" id="t_burn_note"></div>
          <div id="workoutLogTable"></div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 8px" id="t_plan_title"> AI Workout Plan (Mock)</h3>

          <div class="row">
            <select id="wLevel">
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
            <select id="wGoal">
              <option value="fatloss">Fat loss</option>
              <option value="musclegain">Muscle gain</option>
              <option value="general">General fitness</option>
            </select>
          </div>

          <div class="row">
            <select id="wDays">
              <option value="3">3 days / week</option>
              <option value="4">4 days / week</option>
              <option value="5">5 days / week</option>
              <option value="6">6 days / week</option>
            </select>
            <select id="wEquip">
              <option value="gym">Gym</option>
              <option value="home">Home</option>
              <option value="none">No equipment</option>
            </select>
          </div>

          <button class="bP" id="btnGenWorkout" onclick="generateWorkout()">Generate Plan</button>
          <button class="bA" id="btnRegenWorkout" onclick="generateWorkout(true)">Regenerate</button>

          <div class="disclaimer" id="t_workout_ai_disclaimer"></div>
          <div id="workoutPlan"></div>

          <h3 id="t_edit_title"> Notes</h3>
          <textarea id="workoutNotes" placeholder="Write notes here..."></textarea>
          <button class="bS" id="btnSaveNotes" onclick="saveWorkoutNotes()">Save Notes</button>
        </div>
      </div>

      <div id="screenProfile" class="hide">
        <h3 id="t_profile_title"> Profile</h3>
        <div class="disclaimer" id="t_profile_lock_email"></div>

        <div id="profileInfo"></div>

        <div class="section">
          <h3 style="margin:0 0 8px" id="t_profile_edit"> Edit info (Email locked)</h3>
          <div class="row">
            <input id="pName" placeholder="First name">
            <input id="pLname" placeholder="Last name">
          </div>
          <div class="row">
            <input id="pAge" type="number" placeholder="Age">
            <select id="pGender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="row">
            <input id="pWeight" type="number" placeholder="Weight (kg)">
            <input id="pHeight" type="number" placeholder="Height (cm)">
          </div>
          <div class="row">
            <select id="profileGoal">
              <option value="lose">Lose weight</option>
              <option value="maintain">Maintain</option>
              <option value="gain">Gain muscle</option>
            </select>
            <select id="langSwitch" onchange="changeLanguage(this.value)">
              <option value="en">English (ENG)</option>
              <option value="th">‡πÑ‡∏ó‡∏¢ (THA)</option>
            </select>
          </div>

          <button class="bS" id="btnSaveProfile" onclick="saveProfile()">Save Profile</button>
          <div class="disclaimer" id="t_profile_disclaimer"></div>
        </div>
      </div>

      <div id="screenSettings" class="hide">
        <h3 id="t_settings_title"> Settings</h3>

        <div class="section">
          <h3 style="margin:0 0 8px" id="t_storage_title"> Storage Info</h3>
          <div id="storageInfo"></div>
        </div>

        <div class="section">
          <h3 style="margin:0 0 8px" id="t_tutorial_title"> Tutorial</h3>
          <button class="bO" id="btnReplayTutorial" onclick="startUserTutorial(true)">Replay User Tutorial</button>
          <div class="disclaimer" id="t_settings_disclaimer"></div>
        </div>

        <button class="bD" id="btnLogout" onclick="logout()">Logout</button>
      </div>

    </div>
  </div>

  <!-- ================= ADMIN PANEL ================= -->
  <div class="wrap hide" id="adminWrap">
    <div class="card" id="adminBox">
      <div class="topbar">
        <div>
          <div class="who" id="adminTitle"> Admin Panel (Absolute)</div>
          <div class="subbar" id="adminLangLine"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="adminLangSwitch" style="width:auto" onchange="adminChangeLang(this.value)">
            <option value="en">ENG</option>
            <option value="th">TH</option>
          </select>
          <button class="bO" style="width:auto;padding:10px 12px;border-radius:14px" id="btnAdminLogoutTop" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="disclaimer" id="t_admin_disclaimer"></div>

      <div class="section">
        <div class="row">
          <input id="adminSearch" placeholder="Search user/email/id...">
          <button class="bP" onclick="renderAdmin()">Search</button>
        </div>
        <div class="disclaimer" id="t_admin_rules"></div>
      </div>

      <div id="adminStats"></div>

      <div class="adminBox" id="adminData"></div>

      <div class="section">
        <button class="bO" id="btnReplayAdminTutorial" onclick="startAdminTutorial(true)">Replay Admin Tutorial</button>
      </div>

      <button class="bD" id="btnAdminLogout" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Bottom nav (user only) -->
  <div class="bottom-nav hide" id="bottomNav">
    <div class="nav-wrap">
      <div class="tab active" id="tabHome" onclick="goTab('home')">Home</div>
      <div class="tab" id="tabFood" onclick="goTab('food')">Food</div>
      <div class="tab" id="tabWorkout" onclick="goTab('workout')">Workout</div>
      <div class="tab" id="tabProfile" onclick="goTab('profile')">Profile</div>
      <div class="tab" id="tabSettings" onclick="goTab('settings')">Settings</div>
    </div>
  </div>

  <!-- Tutorial overlay -->
  <div class="overlay hide" id="tutorialOverlay">
    <div class="modal">
      <div class="modalTop">
        <div class="tStep" id="tutorialStepLabel">Step 1/6</div>
        <button class="bO xBtn" id="btnTutorialSkip" onclick="tutorialSkip()">Skip</button>
      </div>
      <h3 id="tutorialTitle" style="margin:10px 0 6px"></h3>
      <p id="tutorialBody" style="margin:0 0 12px"></p>
      <div class="disclaimer" id="tutorialDisclaimer"></div>

      <div class="row" style="margin-top:10px">
        <button class="bG" id="btnTutorialBack" onclick="tutorialBack()">Back</button>
        <button class="bS" id="btnTutorialNext" onclick="tutorialNext()">Next</button>
      </div>
    </div>
  </div>

  <!-- Admin Edit Modal -->
  <div class="overlay hide" id="adminEditOverlay">
    <div class="modal">
      <div class="modalTop">
        <div class="modalTitle" id="t_admin_edit_title">Edit user</div>
        <button class="bO xBtn" onclick="closeAdminEdit()">Close</button>
      </div>

      <div class="disclaimer" id="t_admin_edit_note"></div>

      <div class="row">
        <input id="eUser" placeholder="Username">
        <input id="eEmail" placeholder="Email (Admin can edit)">
      </div>

      <div class="row">
        <input id="eName" placeholder="First name">
        <input id="eLname" placeholder="Last name">
      </div>

      <div class="row">
        <input id="eAge" type="number" placeholder="Age">
        <select id="eGender">
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="row">
        <input id="eWeight" type="number" placeholder="Weight (kg)">
        <input id="eHeight" type="number" placeholder="Height (cm)">
      </div>

      <div class="row">
        <select id="eGoal">
          <option value="lose">Lose</option>
          <option value="maintain">Maintain</option>
          <option value="gain">Gain</option>
        </select>
        <select id="eLang">
          <option value="en">EN</option>
          <option value="th">TH</option>
        </select>
      </div>

      <div class="row">
        <select id="eRole">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <input id="ePass" placeholder="New password (optional)">
      </div>

      <div class="row">
        <button class="bP" onclick="adminSaveUser()">Save</button>
        <button class="bA" onclick="adminForceLogout()">Force Logout</button>
      </div>

      <div class="row">
        <button class="bD" onclick="adminDeleteUser()">Delete User</button>
        <button class="bO" onclick="adminResetPassword()">Reset Password (random)</button>
      </div>

      <div class="disclaimer" id="adminEditResult"></div>
    </div>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
/* =========================================================
   EmailJS SETUP (OTP Email)
   1) ‡∏™‡∏£‡πâ‡∏≤‡∏á EmailJS (‡∏ü‡∏£‡∏µ)
   2) ‡∏™‡∏£‡πâ‡∏≤‡∏á Email Service
   3) ‡∏™‡∏£‡πâ‡∏≤‡∏á Template ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£: to_email, otp_code, app_name
   4) ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ 3 ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
========================================================= */
const EMAILJS_PUBLIC_KEY = "d_gKRq39RBdvL8LvK";
const EMAILJS_SERVICE_ID = "service_z4546zd";
const EMAILJS_TEMPLATE_ID = "template_qgy9zw9";

/* =========================================================
   Storage keys
========================================================= */
const LS_USERS   = "fitsense_users";
const LS_UI_LANG = "fitsense_uiLang";
const LS_SESSION = "fitsense_session"; // remember me session

/* =========================================================
   i18n (EN/TH) ‚Äì Minimal but covers key UI
========================================================= */
const I18N = {
  en: {
    study: "Study case only. This is a classroom demo. Not medical advice.",
    storage: "Data is stored in your browser (LocalStorage).",
    regTitle: " Register",
    regSub: "Create your profile to get AI suggestions",
    loginTitle: " Login",
    loginSub: "Welcome back",
    forgotTitle: " Reset password",
    forgotSub: "OTP will be sent to your email",
    remember: "Remember me",
    goLogin: "Go to Login",
    goReg: "Create new account",
    btnRegister: "Register",
    btnLogin: "Login",
    btnForgot: "Forgot Password (OTP Email)",
    sendOtp: "Send OTP to Email",
    reset: "Reset Password",
    cancel: "Cancel",
    logout: "Logout",

    // Validation / errors
    errFillAll: "Please fill every field.",
    errUserLen: "Username must be at least 3 characters.",
    errPassRule: "Password must be at least 6 characters and contain at least 1 special character (!@#$...).",
    errDupUser: "Username already exists.",
    errDupEmail: "Email already exists.",
    errLogin: "Incorrect username or password.",
    errNoEmail: "Email not found.",
    errOtp: "Invalid OTP.",
    errEmailJS: "EmailJS not configured. Please set PUBLIC_KEY / SERVICE_ID / TEMPLATE_ID.",

    // App
    homeTitle: "üè† Home Dashboard",
    homeDisc: "This dashboard shows your daily target, intake, burned calories and net calories.",
    kpiTarget: "Target",
    kpiIntake: "Intake",
    kpiBurned: "Burned",
    kpiNet: "Net",
    kpiRemain: "Remaining",
    aiInsightTitle: " AI Insight (Mock)",
    todaySummary: " Today Summary",

    foodTitle: " Food & Calories",
    genMeals: "Generate AI Meals",
    aiWarn: "AI-generated suggestions (not medical advice).",
    intakeTitle: " Log Intake",
    add: "Add",
    history: " Daily History",
    todayLog: " Today intake list",
    saveGoal: "Save goal",

    workoutTitle: " Workout + Calories Burned",
    burnTitle: " Log Workout (Burned Calories)",
    burnNote: "Calories burned is estimated using MET formula (study).",
    addWorkout: "Add workout",
    planTitle: " AI Workout Plan (Mock)",
    genPlan: "Generate Plan",
    regen: "Regenerate",
    notes: " Notes",
    saveNotes: "Save Notes",

    profileTitle: " Profile",
    profileLock: "You can edit your info, but Email cannot be changed (identifier).",
    saveProfile: "Save Profile",
    profDisc: "Profile is stored locally (mock).",

    settingsTitle: " Settings",
    storageTitle: " Storage Info",
    tutTitle: " Tutorial",
    replayTut: "Replay User Tutorial",
    settingsDisc: "Tutorial follows your current language.",

    // Admin
    adminDis: "Admin has absolute power (study). Can edit/delete/force logout users.",
    adminRules: "Admin actions are for classroom demo only. Use responsibly.",
    replayAdminTut: "Replay Admin Tutorial",
    adminEditTitle: "Edit user",
    adminEditNote: "Admin can edit all fields including email/role. (Study case)",
  },

  th: {
    study: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Study Case) ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£",
    storage: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (LocalStorage)",
    regTitle: " ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
    regSub: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI (‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    loginTitle: " ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    loginSub: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö",
    forgotTitle: " ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
    forgotSub: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á OTP ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    remember: "‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ",
    goLogin: "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    goReg: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
    btnRegister: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
    btnLogin: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    btnForgot: "‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (OTP ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•)",
    sendOtp: "‡∏™‡πà‡∏á OTP ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    reset: "‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà",
    cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    logout: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",

    errFillAll: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á",
    errUserLen: "Username ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£",
    errPassRule: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß (!@#$...)",
    errDupUser: "Username ‡∏ã‡πâ‡∏≥",
    errDupEmail: "Email ‡∏ã‡πâ‡∏≥",
    errLogin: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    errNoEmail: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ",
    errOtp: "OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    errEmailJS: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà PUBLIC_KEY / SERVICE_ID / TEMPLATE_ID",

    homeTitle: " ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (Dashboard)",
    homeDisc: "‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô ‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
    kpiTarget: "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
    kpiIntake: "‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
    kpiBurned: "‡πÄ‡∏ú‡∏≤‡πÑ‡∏õ",
    kpiNet: "‡∏™‡∏∏‡∏ó‡∏ò‡∏¥",
    kpiRemain: "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
    aiInsightTitle: " ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ AI (‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    todaySummary: " ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",

    foodTitle: "üçΩ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ & ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ",
    genMeals: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ AI",
    aiWarn: "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå)",
    intakeTitle: " ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô",
    add: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
    history: " ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô",
    todayLog: " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
    saveGoal: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤",

    workoutTitle: " ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á + ‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏≤",
    burnTitle: " ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á (‡πÄ‡∏ú‡∏≤‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ)",
    burnNote: "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ú‡∏≤‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏£ MET (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)",
    addWorkout: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á",
    planTitle: " ‡πÅ‡∏ú‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ AI (‡∏à‡∏≥‡∏•‡∏≠‡∏á)",
    genPlan: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô",
    regen: "‡∏™‡∏∏‡πà‡∏°/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà",
    notes: " ‡πÇ‡∏ô‡πâ‡∏ï",
    saveNotes: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ô‡πâ‡∏ï",

    profileTitle: " ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå",
    profileLock: "‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ Email ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)",
    saveProfile: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå",
    profDisc: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (LocalStorage) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤",

    settingsTitle: " ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
    storageTitle: " ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    tutTitle: " Tutorial",
    replayTut: "‡πÄ‡∏•‡πà‡∏ô Tutorial ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    settingsDisc: "‡∏†‡∏≤‡∏©‡∏≤ Tutorial ‡∏à‡∏∞‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",

    adminDis: "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö/‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ",
    adminRules: "‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
    replayAdminTut: "‡πÄ‡∏•‡πà‡∏ô Tutorial ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô",
    adminEditTitle: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    adminEditNote: "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á email/role (Study case)",
  }
};

/* =========================================================
   Helpers
========================================================= */
function getUiLang(){ return localStorage.getItem(LS_UI_LANG) || "en"; }
function setUiLang(lang){ localStorage.setItem(LS_UI_LANG, lang); }

function uid(){ return "U" + Math.random().toString(16).slice(2,10).toUpperCase(); }
function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}
function hasSpecialChar(pw){ return /[^A-Za-z0-9]/.test(pw); } // unique character => special char

/* =========================================================
   Load/Save Users
========================================================= */
function loadUsers(){
  try { return JSON.parse(localStorage.getItem(LS_USERS) || "[]"); }
  catch { return []; }
}
function saveUsers(){
  localStorage.setItem(LS_USERS, JSON.stringify(users));
}
function sanitizeUsers(list){
  if(!Array.isArray(list)) return [];
  const out=[];
  const seen=new Set();
  for(const u of list){
    if(!u || typeof u!=="object") continue;
    if(typeof u.user!=="string" || !u.user.trim()) continue;
    if(typeof u.pass!=="string") continue;
    const key=u.user.trim().toLowerCase();
    if(seen.has(key)) continue;
    seen.add(key);

    out.push({
      id: u.id || uid(),
      user: u.user.trim(),
      email: String(u.email||"").trim(),
      pass: u.pass,
      name: String(u.name||"").trim(),
      lname: String(u.lname||"").trim(),
      age: Number(u.age||0),
      gender: u.gender || "other",
      weight: Number(u.weight||0),
      height: Number(u.height||0),
      goal: u.goal || "maintain",
      lang: u.lang || "en",
      role: (u.role==="admin") ? "admin" : "user",
      history: (u.history && typeof u.history==="object") ? u.history : {},
      workoutPlan: u.workoutPlan || null,
      workoutNotes: u.workoutNotes || "",
      firstLaunchDone: !!u.firstLaunchDone,
      firstAdminTutDone: !!u.firstAdminTutDone,
      forceLogoutVersion: Number(u.forceLogoutVersion||0),
      online: !!u.online
    });
  }
  return out;
}

let users = sanitizeUsers(loadUsers());
let currentUser = null;
let otpTemp = null;
let otpEmail = null;

/* Seed admin (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö) */
function ensureAdmin(){
  if(!users.find(u => u.user.toLowerCase()==="admin")){
    users.push({
      id:"ADMIN-0001",
      user:"admin",
      email:"admin@local",
      pass:"Admin@123", // ‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç password
      name:"Admin",
      lname:"System",
      age:0, gender:"other", weight:0, height:0,
      goal:"maintain",
      lang:"en",
      role:"admin",
      history:{},
      workoutPlan:null,
      workoutNotes:"",
      firstLaunchDone:true,
      firstAdminTutDone:false,
      forceLogoutVersion:0,
      online:false
    });
    users = sanitizeUsers(users);
    saveUsers();
  }
}
ensureAdmin();

/* =========================================================
   EmailJS init
========================================================= */
function emailJsReady(){
  return EMAILJS_PUBLIC_KEY && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID
    && !EMAILJS_PUBLIC_KEY.includes("YOUR_")
    && !EMAILJS_SERVICE_ID.includes("YOUR_")
    && !EMAILJS_TEMPLATE_ID.includes("YOUR_");
}
try{
  if(emailJsReady()){
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
  }
}catch(e){
  // ignore; will show error later
}

/* =========================================================
   DOM refs
========================================================= */
const registerBox = document.getElementById("registerBox");
const loginBox = document.getElementById("loginBox");
const forgotBox = document.getElementById("forgotBox");

const appWrap = document.getElementById("appWrap");
const adminWrap = document.getElementById("adminWrap");
const bottomNav = document.getElementById("bottomNav");

const screenHome = document.getElementById("screenHome");
const screenFood = document.getElementById("screenFood");
const screenWorkout = document.getElementById("screenWorkout");
const screenProfile = document.getElementById("screenProfile");
const screenSettings = document.getElementById("screenSettings");

const tutorialOverlay = document.getElementById("tutorialOverlay");
const tutorialStepLabel = document.getElementById("tutorialStepLabel");
const tutorialTitle = document.getElementById("tutorialTitle");
const tutorialBody = document.getElementById("tutorialBody");
const tutorialDisclaimer = document.getElementById("tutorialDisclaimer");
const btnTutorialBack = document.getElementById("btnTutorialBack");
const btnTutorialNext = document.getElementById("btnTutorialNext");
const btnTutorialSkip = document.getElementById("btnTutorialSkip");

const adminEditOverlay = document.getElementById("adminEditOverlay");

/* =========================================================
   i18n apply
========================================================= */
function t(key){
  const lang = currentUser?.lang || getUiLang() || "en";
  const dict = I18N[lang] || I18N.en;
  return dict[key] ?? key;
}

function applyStaticI18n(){
  const uiLang = getUiLang();
  const dict = I18N[uiLang] || I18N.en;

  // sync dropdowns
  document.getElementById("regLangSwitch").value = uiLang;
  document.getElementById("loginLangSwitch").value = uiLang;
  document.getElementById("forgotLangSwitch").value = uiLang;

  // register text
  document.getElementById("t_reg_title").innerText = dict.regTitle;
  document.getElementById("t_reg_sub").innerText = dict.regSub;
  document.getElementById("btnRegister").innerText = dict.btnRegister;
  document.getElementById("btnGoLogin").innerText = dict.goLogin;

  // login text
  document.getElementById("t_login_title").innerText = dict.loginTitle;
  document.getElementById("t_login_sub").innerText = dict.loginSub;
  document.getElementById("t_remember").innerText = dict.remember;
  document.getElementById("btnLogin").innerText = dict.btnLogin;
  document.getElementById("btnForgot").innerText = dict.btnForgot;
  document.getElementById("btnGoRegister").innerText = dict.goReg;

  // forgot
  document.getElementById("t_forgot_title").innerText = dict.forgotTitle;
  document.getElementById("t_forgot_sub").innerText = dict.forgotSub;
  document.getElementById("btnSendOTP").innerText = dict.sendOtp;
  document.getElementById("btnReset").innerText = dict.reset;
  document.getElementById("btnCancelReset").innerText = dict.cancel;

  // disclaimers
  document.getElementById("t_auth_disclaimer").innerText = `${dict.study}\n${dict.storage}\n(Admin account exists for demo: admin / Admin@123)`;
  document.getElementById("t_auth_disclaimer2").innerText = `${dict.study}\n${dict.storage}`;
  document.getElementById("t_otp_disclaimer").innerText = `${dict.study}\n${dict.storage}`;

  // placeholders (minor)
  document.getElementById("rUser").placeholder = (uiLang==="th") ? "Username (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß)" : "Username (‚â• 3 chars)";
  document.getElementById("rPass").placeholder = (uiLang==="th") ? "Password (‚â• 6 + ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©)" : "Password (‚â• 6 + special char)";
}

/* =========================================================
   Screens show/hide
========================================================= */
function hideAll(){
  registerBox.classList.add("hide");
  loginBox.classList.add("hide");
  forgotBox.classList.add("hide");
  appWrap.classList.add("hide");
  adminWrap.classList.add("hide");
  bottomNav.classList.add("hide");
}
function showRegister(){
  hideAll();
  registerBox.classList.remove("hide");
  applyStaticI18n();
}
function showLogin(){
  hideAll();
  loginBox.classList.remove("hide");
  applyStaticI18n();
}
function showForgot(){
  hideAll();
  forgotBox.classList.remove("hide");
  applyStaticI18n();
}

/* =========================================================
   Register validation (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏™‡∏±‡πà‡∏á)
========================================================= */
function validateRegisterForm(){
  const uiLang = getUiLang();
  const dict = I18N[uiLang] || I18N.en;

  const u = document.getElementById("rUser").value.trim();
  const e = document.getElementById("rEmail").value.trim();
  const p = document.getElementById("rPass").value.trim();
  const name = document.getElementById("rName").value.trim();
  const lname = document.getElementById("rLname").value.trim();
  const age = document.getElementById("rAge").value.trim();
  const gender = document.getElementById("rGender").value;
  const weight = document.getElementById("rWeight").value.trim();
  const height = document.getElementById("rHeight").value.trim();
  const goal = document.getElementById("rGoal").value;
  const lang = document.getElementById("rLang").value;

  // Must fill every field
  if(!u||!e||!p||!name||!lname||!age||!gender||!weight||!height||!goal||!lang){
    alert(dict.errFillAll); return null;
  }
  if(u.length < 3){ alert(dict.errUserLen); return null; }
  if(p.length < 6 || !hasSpecialChar(p)){ alert(dict.errPassRule); return null; }

  if(users.find(x => x.user.toLowerCase() === u.toLowerCase())){ alert(dict.errDupUser); return null; }
  if(users.find(x => (x.email||"").toLowerCase() === e.toLowerCase())){ alert(dict.errDupEmail); return null; }

  return {
    user: u, email: e, pass: p,
    name, lname,
    age: Number(age), gender,
    weight: Number(weight), height: Number(height),
    goal, lang
  };
}

function register(){
  const data = validateRegisterForm();
  if(!data) return;

  // register page language switch => set UI language immediately
  setUiLang(document.getElementById("regLangSwitch").value);

  users.push({
    id: uid(),
    user: data.user,
    email: data.email,
    pass: data.pass,
    name: data.name,
    lname: data.lname,
    age: data.age,
    gender: data.gender,
    weight: data.weight,
    height: data.height,
    goal: data.goal,
    lang: data.lang,
    role: "user",
    history: {},
    workoutPlan: null,
    workoutNotes: "",
    firstLaunchDone: false,
    firstAdminTutDone: false,
    forceLogoutVersion: 0,
    online: false
  });

  users = sanitizeUsers(users);
  saveUsers();

  alert(getUiLang()==="th" ? "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ" : "Registered ‚úÖ");
  showLogin();
}

/* =========================================================
   Session + Force Logout (Local-only)
========================================================= */
function setSession(user, remember){
  const session = {
    username: user.user,
    forceLogoutVersion: user.forceLogoutVersion || 0,
    ts: Date.now()
  };
  if(remember) localStorage.setItem(LS_SESSION, JSON.stringify(session));
  else localStorage.removeItem(LS_SESSION);
}

function clearSession(){
  localStorage.removeItem(LS_SESSION);
}

function checkForcedLogout(){
  // If admin forced logout, user's forceLogoutVersion will differ.
  const raw = localStorage.getItem(LS_SESSION);
  if(!raw || !currentUser) return;
  try{
    const s = JSON.parse(raw);
    if((s.forceLogoutVersion ?? 0) !== (currentUser.forceLogoutVersion ?? 0)){
      alert(currentUser.lang==="th" ? "‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô" : "You were forced logged out by admin.");
      logout(true);
    }
  }catch{}
}

/* =========================================================
   Login/Logout
========================================================= */
function login(){
  const uiLang = getUiLang();
  const dict = I18N[uiLang] || I18N.en;

  const uName = document.getElementById("lUser").value.trim();
  const uPass = document.getElementById("lPass").value.trim();

  const u = users.find(x => x.user.toLowerCase() === uName.toLowerCase() && x.pass === uPass);
  if(!u){ alert(dict.errLogin); return; }

  currentUser = u;
  currentUser.online = true;

  // Set UI language based on user profile
  setUiLang(currentUser.lang);
  saveUsers();

  setSession(currentUser, document.getElementById("rememberMe").checked);

  if(currentUser.role === "admin"){
    bootAdmin();
  }else{
    bootUserApp();
  }
}

function logout(silent=false){
  if(currentUser){
    currentUser.online = false;
    saveUsers();
  }
  clearSession();
  currentUser = null;
  if(!silent) location.reload();
  else location.reload();
}

/* =========================================================
   Forgot Password - Email OTP (EmailJS)
========================================================= */
async function sendOTP(){
  const uiLang = getUiLang();
  const dict = I18N[uiLang] || I18N.en;

  const email = document.getElementById("fEmail").value.trim();
  const u = users.find(x => (x.email||"").toLowerCase() === email.toLowerCase());
  if(!u){ alert(dict.errNoEmail); return; }

  otpTemp = Math.floor(100000 + Math.random()*900000);
  otpEmail = u.email;

  if(!emailJsReady()){
    alert(dict.errEmailJS);
    // fallback for demo: show OTP
    alert((uiLang==="th"?"OTP (‡πÄ‡∏î‡πÇ‡∏°): ":"OTP (Demo): ") + otpTemp);
    return;
  }

  try{
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      to_email: otpEmail,
      otp_code: String(otpTemp),
      app_name: "FitSense AI"
    });
    alert(uiLang==="th" ? "‡∏™‡πà‡∏á OTP ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "OTP sent ‚úÖ");
  }catch(e){
    alert(uiLang==="th" ? "‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏£‡∏ß‡∏à EmailJS)" : "Email failed (check EmailJS)");
  }
}

function resetPassword(){
  const uiLang = getUiLang();
  const dict = I18N[uiLang] || I18N.en;

  const otp = document.getElementById("fOTP").value.trim();
  const newPass = document.getElementById("fNewPass").value.trim();

  if(newPass.length < 6 || !hasSpecialChar(newPass)){
    alert(dict.errPassRule); return;
  }
  if(!otpTemp || otp !== String(otpTemp)){
    alert(dict.errOtp); return;
  }

  const u = users.find(x => (x.email||"") === otpEmail);
  if(u) u.pass = newPass;

  otpTemp = null; otpEmail = null;
  saveUsers();

  alert(uiLang==="th" ? "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "Password updated ‚úÖ");
  showLogin();
}

/* =========================================================
   Calorie target (simple estimate)
========================================================= */
function calcTargetCalories(user){
  const w = Number(user.weight || 0);
  const h = Number(user.height || 0);
  const a = Number(user.age || 0);
  if(!w || !h || !a) return 2000;

  const s = (user.gender === "male") ? 5 : (user.gender === "female") ? -161 : -78;
  const bmr = (10*w) + (6.25*h) - (5*a) + s;
  let tdee = bmr * 1.35; // light activity baseline

  if(user.goal === "lose") tdee -= 400;
  if(user.goal === "gain") tdee += 300;

  return Math.max(1200, Math.round(tdee));
}

function ensureTodayHistory(){
  const d = todayKey();
  if(!currentUser.history) currentUser.history = {};
  if(!currentUser.history[d]){
    currentUser.history[d] = {
      target: calcTargetCalories(currentUser),
      manualGoal: null,
      meals: null,
      intakes: [],
      intakeTotal: 0,
      workouts: [],
      burnedTotal: 0
    };
  }else{
    currentUser.history[d].target = calcTargetCalories(currentUser);
    if(!Array.isArray(currentUser.history[d].intakes)) currentUser.history[d].intakes = [];
    if(!Array.isArray(currentUser.history[d].workouts)) currentUser.history[d].workouts = [];
    currentUser.history[d].intakeTotal = currentUser.history[d].intakes.reduce((s,x)=>s+Number(x.cal||0),0);
    currentUser.history[d].burnedTotal = currentUser.history[d].workouts.reduce((s,x)=>s+Number(x.burn||0),0);
  }
  saveUsers();
}
function getTodayDay(){
  ensureTodayHistory();
  return currentUser.history[todayKey()];
}

/* =========================================================
   App boot + i18n
========================================================= */
function applyAppI18n(){
  // Tabs
  document.getElementById("tabHome").innerText = (currentUser.lang==="th")?"‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å":"Home";
  document.getElementById("tabFood").innerText = (currentUser.lang==="th")?"‡∏≠‡∏≤‡∏´‡∏≤‡∏£":"Food";
  document.getElementById("tabWorkout").innerText = (currentUser.lang==="th")?"‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á":"Workout";
  document.getElementById("tabProfile").innerText = (currentUser.lang==="th")?"‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå":"Profile";
  document.getElementById("tabSettings").innerText = (currentUser.lang==="th")?"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤":"Settings";

  // Headings & buttons
  document.getElementById("t_home_title").innerText = t("homeTitle");
  document.getElementById("t_home_disclaimer").innerText = `${t("homeDisc")}\n${t("study")}`;

  document.getElementById("t_food_title").innerText = t("foodTitle");
  document.getElementById("btnGenMeals").innerText = t("genMeals");
  document.getElementById("t_ai_disclaimer").innerText = `${t("aiWarn")} ‚Ä¢ ${t("study")}`;
  document.getElementById("t_intake_title").innerText = t("intakeTitle");
  document.getElementById("btnAddIntake").innerText = t("add");
  document.getElementById("t_today_log").innerText = t("todayLog");
  document.getElementById("t_history_title").innerText = t("history");
  document.getElementById("btnSaveManualGoal").innerText = t("saveGoal");
  document.getElementById("t_calorie_note").innerText = `${t("aiWarn")}\n${t("study")}`;

  document.getElementById("t_workout_title").innerText = t("workoutTitle");
  document.getElementById("t_burn_title").innerText = t("burnTitle");
  document.getElementById("t_burn_note").innerText = t("burnNote");
  document.getElementById("btnAddWorkoutLog").innerText = t("addWorkout");
  document.getElementById("t_plan_title").innerText = t("planTitle");
  document.getElementById("btnGenWorkout").innerText = t("genPlan");
  document.getElementById("btnRegenWorkout").innerText = t("regen");
  document.getElementById("t_workout_ai_disclaimer").innerText = `${t("aiWarn")} ‚Ä¢ ${t("study")}`;
  document.getElementById("t_edit_title").innerText = t("notes");
  document.getElementById("btnSaveNotes").innerText = t("saveNotes");

  document.getElementById("t_profile_title").innerText = t("profileTitle");
  document.getElementById("t_profile_lock_email").innerText = t("profileLock");
  document.getElementById("btnSaveProfile").innerText = t("saveProfile");
  document.getElementById("t_profile_disclaimer").innerText = t("profDisc");

  document.getElementById("t_settings_title").innerText = t("settingsTitle");
  document.getElementById("t_storage_title").innerText = t("storageTitle");
  document.getElementById("t_tutorial_title").innerText = t("tutTitle");
  document.getElementById("btnReplayTutorial").innerText = t("replayTut");
  document.getElementById("t_settings_disclaimer").innerText = `${t("settingsDisc")}\n${t("study")}`;

  document.getElementById("btnLogout").innerText = t("logout");
  document.getElementById("btnLogoutTop").innerText = t("logout");
}

function bootUserApp(){
  hideAll();
  appWrap.classList.remove("hide");
  bottomNav.classList.remove("hide");

  document.getElementById("welcome").innerText =
    (currentUser.lang==="th") ? `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${currentUser.name}` : `Hello ${currentUser.name}`;
  document.getElementById("topLang").innerText = `Language: ${String(currentUser.lang).toUpperCase()}`;

  document.getElementById("langSwitch").value = currentUser.lang;

  applyAppI18n();
  ensureTodayHistory();
  goTab("home", true);
  renderStorageInfo();
  startUserTutorial(false);
  checkForcedLogout();
}

/* =========================================================
   Tabs
========================================================= */
function goTab(tab, silent=false){
  screenHome.classList.add("hide");
  screenFood.classList.add("hide");
  screenWorkout.classList.add("hide");
  screenProfile.classList.add("hide");
  screenSettings.classList.add("hide");

  ["Home","Food","Workout","Profile","Settings"].forEach(x=>{
    document.getElementById("tab"+x).classList.remove("active");
  });

  if(tab==="home"){ screenHome.classList.remove("hide"); document.getElementById("tabHome").classList.add("active"); renderHome(); }
  if(tab==="food"){ screenFood.classList.remove("hide"); document.getElementById("tabFood").classList.add("active"); renderFood(); }
  if(tab==="workout"){ screenWorkout.classList.remove("hide"); document.getElementById("tabWorkout").classList.add("active"); renderWorkout(); }
  if(tab==="profile"){ screenProfile.classList.remove("hide"); document.getElementById("tabProfile").classList.add("active"); renderProfile(); }
  if(tab==="settings"){ screenSettings.classList.remove("hide"); document.getElementById("tabSettings").classList.add("active"); renderStorageInfo(); }

  if(!silent) clearHighlight();
  checkForcedLogout();
}

/* =========================================================
   Home (Improved)
========================================================= */
function renderHome(){
  const day = getTodayDay();
  const target = (day.manualGoal!=null) ? day.manualGoal : day.target;
  const intake = day.intakeTotal || 0;
  const burned = day.burnedTotal || 0;
  const net = Math.max(0, intake - burned); // simple net
  const remain = target - net;

  const remainText = (remain>=0) ? remain : -remain;
  const remainLabel = (remain>=0) ? t("kpiRemain") : (currentUser.lang==="th" ? "‡πÄ‡∏Å‡∏¥‡∏ô" : "Over");

  const kpis = [
    {cls:"p", label:t("kpiTarget"), val:target, hint:(currentUser.lang==="th"?"kcal/‡∏ß‡∏±‡∏ô":"kcal/day")},
    {cls:"a", label:t("kpiIntake"), val:intake, hint:(currentUser.lang==="th"?"‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£":"from intake logs")},
    {cls:"s", label:t("kpiBurned"), val:burned, hint:(currentUser.lang==="th"?"‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á":"from workout logs")},
    {cls: (remain>=0) ? "p" : "d", label:remainLabel, val:remainText, hint:(currentUser.lang==="th"?"‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥":"net remaining")}
  ];

  document.getElementById("homeKpis").innerHTML = kpis.map(k=>`
    <div class="kpi ${k.cls}">
      <div class="label">${k.label}</div>
      <div class="val">${k.val}</div>
      <div class="hint">${k.hint}</div>
    </div>
  `).join("");

  // AI Insight (simple rules)
  let insight = "";
  if(net > target){
    insight = (currentUser.lang==="th")
      ? `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ\n‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° 15‚Äì25 ‡∏ô‡∏≤‡∏ó‡∏µ`
      : `You are over target today ‚úÖ\nTip: reduce sweets/fried food or add 15‚Äì25 min walk.`;
  }else if(remain > 500){
    insight = (currentUser.lang==="th")
      ? `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å\n‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô/‡∏ú‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û`
      : `You still have many calories remaining.\nTip: choose protein/veg meal or healthy snack.`;
  }else{
    insight = (currentUser.lang==="th")
      ? `‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∏‡∏°‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πÑ‡∏î‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢\n‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`
      : `Great! You're close to your target.\nTip: stay hydrated and sleep well.`;
  }

  document.getElementById("aiInsightBox").innerHTML = `
    <h3 style="margin:0 0 8px">${t("aiInsightTitle")}</h3>
    <div style="white-space:pre-line;color:var(--muted);font-weight:600">${escapeHtml(insight)}</div>
  `;

  // Tables
  document.getElementById("t_today_tables").innerText = t("todaySummary");
  document.getElementById("homeTables").innerHTML = `
    <table>
      <tr>
        <th>${t("kpiTarget")}</th>
        <th>${t("kpiIntake")}</th>
        <th>${t("kpiBurned")}</th>
        <th>${t("kpiNet")}</th>
      </tr>
      <tr>
        <td>${target}</td>
        <td>${intake}</td>
        <td>${burned}</td>
        <td>${net}</td>
      </tr>
    </table>
  `;
}

/* =========================================================
   Food (AI mock + intake)
========================================================= */
function renderFood(){
  const day = getTodayDay();
  const target = (day.manualGoal!=null) ? day.manualGoal : day.target;
  const intake = day.intakeTotal || 0;
  const burned = day.burnedTotal || 0;
  const net = Math.max(0, intake - burned);
  const remain = target - net;
  const remainText = (remain>=0) ? remain : (currentUser.lang==="th" ? `‡πÄ‡∏Å‡∏¥‡∏ô ${-remain}` : `Over ${-remain}`);

  document.getElementById("calorieSummary").innerHTML = `
    <table>
      <tr><th>${t("kpiTarget")}</th><th>${t("kpiIntake")}</th><th>${t("kpiBurned")}</th><th>${t("kpiRemain")}</th></tr>
      <tr><td>${target}</td><td>${intake}</td><td>${burned}</td><td>${remainText}</td></tr>
    </table>
  `;

  if(day.meals){
    document.getElementById("aiMealTable").innerHTML = renderMealTable(day.meals);
  }else{
    document.getElementById("aiMealTable").innerHTML = `<div style="color:var(--muted)">${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π":"Not generated yet"}</div>`;
  }

  document.getElementById("manualGoal").value = (day.manualGoal ?? "");
  renderTodayIntakeLog();
  renderHistory();
}

function renderMealTable(meals){
  const total = meals.reduce((s,m)=>s+m.cal,0);
  const rows = meals.map(m=>`
    <tr><td>${escapeHtml(m.time)}</td><td style="text-align:left">${escapeHtml(m.name)}</td><td>${m.cal}</td></tr>
  `).join("");
  return `
    <div class="section">
      <h3 style="margin:0 0 8px">${currentUser.lang==="th"?"‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å AI (‡∏à‡∏≥‡∏•‡∏≠‡∏á)":"AI Meal Plan (Mock)"}</h3>
      <table>
        <tr><th>${currentUser.lang==="th"?"‡∏°‡∏∑‡πâ‡∏≠":"Time"}</th><th>${currentUser.lang==="th"?"‡∏≠‡∏≤‡∏´‡∏≤‡∏£":"Meal"}</th><th>kcal</th></tr>
        ${rows}
        <tr><th colspan="2">${currentUser.lang==="th"?"‡∏£‡∏ß‡∏°":"Total"}</th><th>${total}</th></tr>
      </table>
      <div class="disclaimer">${t("aiWarn")}</div>
    </div>
  `;
}

function generateMeals(){
  const day = getTodayDay();
  const goal = currentUser.goal || "maintain";
  const lang = currentUser.lang;

  const foodsEN = {
    protein: ["Chicken breast","Salmon","Eggs","Tofu","Greek yogurt"],
    carbs: ["Rice","Oats","Sweet potato","Whole-wheat bread","Quinoa"],
    veg: ["Salad","Broccoli","Mixed vegetables","Spinach","Tomato soup"],
    snack: ["Banana","Nuts","Apple","Protein bar","Milk"]
  };
  const foodsTH = {
    protein: ["‡∏≠‡∏Å‡πÑ‡∏Å‡πà","‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô","‡πÑ‡∏Ç‡πà","‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ","‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï‡∏Å‡∏£‡∏µ‡∏Å"],
    carbs: ["‡∏Ç‡πâ‡∏≤‡∏ß","‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏≠‡πä‡∏ï","‡∏°‡∏±‡∏ô‡∏´‡∏ß‡∏≤‡∏ô","‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ï","‡∏Ñ‡∏ß‡∏¥‡∏ô‡∏±‡∏ß"],
    veg: ["‡∏™‡∏•‡∏±‡∏î","‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ","‡∏ú‡∏±‡∏Å‡∏£‡∏ß‡∏°","‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°","‡∏ã‡∏∏‡∏õ‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®"],
    snack: ["‡∏Å‡∏•‡πâ‡∏ß‡∏¢","‡∏ñ‡∏±‡πà‡∏ß","‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•","‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ö‡∏≤‡∏£‡πå","‡∏ô‡∏°"]
  };
  const F = (lang==="th") ? foodsTH : foodsEN;

  const base = (goal==="lose") ? 1600 : (goal==="gain") ? 2400 : 2000;
  const split = { b:0.28, l:0.34, d:0.28, s:0.10 };

  const pick = arr => arr[Math.floor(Math.random()*arr.length)];
  const calFor = frac => Math.max(80, Math.round(base*frac + (Math.random()*90-45)));

  const meals = [
    { time:(lang==="th"?"‡πÄ‡∏ä‡πâ‡∏≤":"Breakfast"), name:`${pick(F.protein)} + ${pick(F.carbs)}`, cal:calFor(split.b) },
    { time:(lang==="th"?"‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á":"Lunch"), name:`${pick(F.protein)} + ${pick(F.veg)} + ${pick(F.carbs)}`, cal:calFor(split.l) },
    { time:(lang==="th"?"‡πÄ‡∏¢‡πá‡∏ô":"Dinner"), name:`${pick(F.protein)} + ${pick(F.veg)}`, cal:calFor(split.d) },
    { time:(lang==="th"?"‡∏ß‡πà‡∏≤‡∏á":"Snack"), name:`${pick(F.snack)}`, cal:calFor(split.s) },
  ];

  day.meals = meals;
  saveUsers();
  renderFood();
  renderHome();
}

function addIntake(){
  const name = document.getElementById("intakeName").value.trim();
  const cal = Number(document.getElementById("intakeCal").value || 0);
  if(!name || !cal){ alert(currentUser.lang==="th"?"‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ":"Enter food name and calories"); return; }

  const day = getTodayDay();
  day.intakes.unshift({ name, cal, ts: Date.now() });
  day.intakeTotal = day.intakes.reduce((s,x)=>s+Number(x.cal||0),0);
  saveUsers();

  document.getElementById("intakeName").value="";
  document.getElementById("intakeCal").value="";
  renderFood(); renderHome();
}

function quickAdd(kcal){
  const n = document.getElementById("intakeName").value.trim() || (currentUser.lang==="th"?"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πà‡∏ß‡∏ô":"Quick add");
  document.getElementById("intakeName").value = n;
  document.getElementById("intakeCal").value = kcal;
  addIntake();
}

function deleteIntake(index){
  const day = getTodayDay();
  day.intakes.splice(index,1);
  day.intakeTotal = day.intakes.reduce((s,x)=>s+Number(x.cal||0),0);
  saveUsers();
  renderFood(); renderHome();
}

function renderTodayIntakeLog(){
  const day = getTodayDay();
  const list = day.intakes || [];
  if(!list.length){
    document.getElementById("intakeLogTable").innerHTML =
      `<p style="text-align:center;color:var(--muted)">${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ":"No intake yet today"}</p>`;
    return;
  }

  let html = `<table>
    <tr>
      <th>${currentUser.lang==="th"?"‡πÄ‡∏ß‡∏•‡∏≤":"Time"}</th>
      <th>${currentUser.lang==="th"?"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£":"Item"}</th>
      <th>kcal</th>
      <th>${currentUser.lang==="th"?"‡∏•‡∏ö":"Del"}</th>
    </tr>`;

  list.forEach((it, idx)=>{
    const time = new Date(it.ts).toLocaleTimeString(currentUser.lang==="th"?"th-TH":"en-US",{hour:"2-digit",minute:"2-digit"});
    html += `<tr>
      <td>${time}</td>
      <td style="text-align:left">${escapeHtml(it.name)}</td>
      <td>${Number(it.cal||0)}</td>
      <td><button class="bD" style="margin:0;padding:8px;border-radius:12px;box-shadow:none" onclick="deleteIntake(${idx})">
        ${currentUser.lang==="th"?"‡∏•‡∏ö":"Delete"}
      </button></td>
    </tr>`;
  });
  html += `</table>`;
  document.getElementById("intakeLogTable").innerHTML = html;
}

function saveManualGoal(){
  const v = document.getElementById("manualGoal").value.trim();
  const day = getTodayDay();

  if(v===""){
    day.manualGoal = null;
    saveUsers();
    renderFood(); renderHome();
    return;
  }
  const n = Number(v);
  if(!Number.isFinite(n) || n<=0){
    alert(currentUser.lang==="th"?"‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á":"Enter a valid goal"); return;
  }
  day.manualGoal = Math.round(n);
  saveUsers();
  renderFood(); renderHome();
}

function renderHistory(){
  const keys = Object.keys(currentUser.history || {}).sort().slice(-10).reverse();
  let html = `<table><tr>
    <th>${currentUser.lang==="th"?"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà":"Date"}</th>
    <th>${t("kpiTarget")}</th>
    <th>${t("kpiIntake")}</th>
    <th>${t("kpiBurned")}</th>
  </tr>`;

  for(const k of keys){
    const d = currentUser.history[k];
    const target = (d.manualGoal!=null) ? d.manualGoal : (d.target||"-");
    html += `<tr><td>${k}</td><td>${target}</td><td>${d.intakeTotal||0}</td><td>${d.burnedTotal||0}</td></tr>`;
  }
  html += `</table>`;
  document.getElementById("historyTable").innerHTML = html;
}

/* =========================================================
   Workout Burn (MET)
========================================================= */
const MET = {
  walk:   { light:2.8, moderate:3.5, hard:4.3 },
  run:    { light:7.0, moderate:9.8, hard:11.5 },
  cycle:  { light:4.0, moderate:6.8, hard:8.5 },
  weights:{ light:3.5, moderate:5.0, hard:6.0 },
  hiit:   { light:7.5, moderate:9.0, hard:10.5 }
};

function calcBurnedCalories(weightKg, minutes, met){
  const hours = Math.max(0, Number(minutes||0)) / 60;
  return Math.max(0, Math.round(met * weightKg * hours));
}

function addWorkoutLog(){
  const day = getTodayDay();
  const type = document.getElementById("wType").value;
  const intensity = document.getElementById("wIntensity").value;
  const minutes = Number(document.getElementById("wMinutes").value || 0);

  if(!minutes || minutes<=0){
    alert(currentUser.lang==="th"?"‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á":"Enter valid minutes"); return;
  }

  const met = MET[type]?.[intensity] ?? 5.0;
  const burn = calcBurnedCalories(currentUser.weight||60, minutes, met);

  day.workouts.unshift({
    type, intensity, minutes, met, burn,
    ts: Date.now()
  });
  day.burnedTotal = day.workouts.reduce((s,x)=>s+Number(x.burn||0),0);

  saveUsers();
  document.getElementById("wMinutes").value = "";
  renderWorkout(); renderHome(); renderFood();
}

function deleteWorkout(index){
  const day = getTodayDay();
  day.workouts.splice(index,1);
  day.burnedTotal = day.workouts.reduce((s,x)=>s+Number(x.burn||0),0);
  saveUsers();
  renderWorkout(); renderHome(); renderFood();
}

function renderWorkoutLog(){
  const day = getTodayDay();
  const list = day.workouts || [];
  if(!list.length){
    document.getElementById("workoutLogTable").innerHTML =
      `<p style="text-align:center;color:var(--muted)">${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ":"No workout logged today"}</p>`;
    return;
  }

  let html = `<table>
    <tr>
      <th>${currentUser.lang==="th"?"‡πÄ‡∏ß‡∏•‡∏≤":"Time"}</th>
      <th>${currentUser.lang==="th"?"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó":"Type"}</th>
      <th>${currentUser.lang==="th"?"‡∏ô‡∏≤‡∏ó‡∏µ":"Min"}</th>
      <th>MET</th>
      <th>${currentUser.lang==="th"?"‡πÄ‡∏ú‡∏≤":"Burn"}</th>
      <th>${currentUser.lang==="th"?"‡∏•‡∏ö":"Del"}</th>
    </tr>`;

  list.forEach((w, idx)=>{
    const time = new Date(w.ts).toLocaleTimeString(currentUser.lang==="th"?"th-TH":"en-US",{hour:"2-digit",minute:"2-digit"});
    const typeName = ({walk:"Walk",run:"Run",cycle:"Cycle",weights:"Weights",hiit:"HIIT"})[w.type] || w.type;
    html += `<tr>
      <td>${time}</td>
      <td style="text-align:left">${escapeHtml(typeName)} (${escapeHtml(w.intensity)})</td>
      <td>${w.minutes}</td>
      <td>${w.met}</td>
      <td>${w.burn}</td>
      <td><button class="bD" style="margin:0;padding:8px;border-radius:12px;box-shadow:none" onclick="deleteWorkout(${idx})">
        ${currentUser.lang==="th"?"‡∏•‡∏ö":"Delete"}
      </button></td>
    </tr>`;
  });

  html += `</table>`;
  document.getElementById("workoutLogTable").innerHTML = html;
}

/* =========================================================
   Workout plan generator (mock)
========================================================= */
function renderWorkout(){
  renderWorkoutLog();

  if(currentUser.workoutPlan){
    document.getElementById("workoutPlan").innerHTML = renderWorkoutPlan(currentUser.workoutPlan);
  }else{
    document.getElementById("workoutPlan").innerHTML =
      `<div style="color:var(--muted)">${currentUser.lang==="th"?"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô":"Not generated yet"}</div>`;
  }
  document.getElementById("workoutNotes").value = currentUser.workoutNotes || "";
}

function generateWorkout(){
  const level = document.getElementById("wLevel").value;
  const goal = document.getElementById("wGoal").value;
  const days = Number(document.getElementById("wDays").value);
  const equip = document.getElementById("wEquip").value;
  const lang = currentUser.lang;

  const ex = {
    gym: {
      upper: lang==="th" ? ["‡∏î‡∏±‡∏ô‡∏≠‡∏Å‡πÅ‡∏°‡∏ä‡∏ä‡∏µ‡∏ô","Lat Pulldown","‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•‡∏ä‡∏≠‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏£‡∏™","‡πÄ‡∏Ñ‡πÄ‡∏ö‡∏¥‡∏•‡πÇ‡∏£‡∏ß‡πå","‡πÑ‡∏ó‡∏£‡πÄ‡∏ã‡πá‡∏õ‡∏™‡πå‡∏Å‡∏î‡∏•‡∏á"] : ["Chest press","Lat pulldown","DB shoulder press","Cable row","Triceps pushdown"],
      lower: lang==="th" ? ["‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó","‡πÄ‡∏•‡∏Å‡πÄ‡∏û‡∏£‡∏™","RDL","‡πÄ‡∏•‡∏Å‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡πÄ‡∏ó‡∏ô‡∏ä‡∏±‡∏ô","‡πÅ‡∏Æ‡∏°‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏Ñ‡∏π‡∏•"] : ["Squat","Leg press","RDL","Leg extension","Hamstring curl"],
      cardio: lang==="th" ? ["‡πÄ‡∏î‡∏¥‡∏ô‡∏ä‡∏±‡∏ô 20 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ"] : ["Incline walk 20 min","Bike 15 min"]
    },
    home: {
      upper: lang==="th" ? ["‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô","‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•‡πÇ‡∏£‡∏ß‡πå","‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•‡∏ä‡∏≠‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏£‡∏™","‡πÑ‡∏ö‡πÄ‡∏ã‡πá‡∏õ‡∏™‡πå‡πÄ‡∏Ñ‡∏¥‡∏£‡πå‡∏•","‡∏ó‡∏£‡∏¥‡πÄ‡∏ã‡πá‡∏õ‡∏™‡πå‡∏î‡∏¥‡∏õ"] : ["Push-ups","DB rows","DB shoulder press","Biceps curl","Triceps dips"],
      lower: lang==="th" ? ["‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏ß","‡∏•‡∏±‡∏ô‡∏à‡πå","‡∏Å‡∏•‡∏π‡∏ï‡∏ö‡∏£‡∏¥‡∏î‡∏à‡πå","‡πÄ‡∏î‡∏î‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏î‡∏±‡∏°‡πÄ‡∏ö‡∏•","‡∏Ñ‡∏≤‡∏•‡πå‡∏ü‡πÄ‡∏£‡∏™"] : ["Bodyweight squats","Lunges","Glute bridge","DB deadlift","Calf raises"],
      cardio: lang==="th" ? ["‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ï‡∏ö 10 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 12 ‡∏ô‡∏≤‡∏ó‡∏µ"] : ["Jumping jacks 10 min","High knees 12 min"]
    },
    none: {
      upper: lang==="th" ? ["‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô","‡πÅ‡∏û‡∏•‡∏á‡∏Å‡πå‡πÑ‡∏´‡∏•‡πà‡πÅ‡∏ï‡∏∞","‡πÑ‡∏î‡∏°‡∏≠‡∏ô‡∏î‡πå‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô","‡∏≠‡∏¥‡∏ô‡∏ä‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏°"] : ["Push-ups","Plank shoulder taps","Diamond push-ups","Inchworms"],
      lower: lang==="th" ? ["‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó","‡∏•‡∏±‡∏ô‡∏à‡πå","‡∏ß‡∏≠‡∏•‡∏•‡πå‡∏ã‡∏¥‡∏ó","‡∏Å‡∏•‡∏π‡∏ï‡∏ö‡∏£‡∏¥‡∏î‡∏à‡πå"] : ["Squats","Lunges","Wall sit","Glute bridge"],
      cardio: lang==="th" ? ["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏µ 8 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà 10 ‡∏ô‡∏≤‡∏ó‡∏µ"] : ["Burpees 8 min","High knees 10 min"]
    }
  };

  const diff = {
    beginner: { sets:3, reps:"10-12", rest:60 },
    intermediate: { sets:4, reps:"8-12", rest:75 },
    advanced: { sets:5, reps:"6-10", rest:90 }
  }[level];

  const pick = (arr)=>{
    const copy=[...arr]; copy.sort(()=>Math.random()-0.5);
    return copy.slice(0, Math.min(4,copy.length));
  };

  const plan=[];
  for(let i=1;i<=days;i++){
    const isUpper = (i%2===1);
    const group = isUpper ? "upper" : "lower";
    const main = pick(ex[equip][group]).map(name=>({ name, sets:diff.sets, reps:diff.reps, rest:diff.rest }));
    const cardio = (goal==="fatloss" || goal==="general")
      ? pick(ex[equip].cardio).map(name=>({ name, sets:1, reps:lang==="th"?"‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤":"time-based", rest:0 }))
      : [];
    plan.push({
      day: (lang==="th"?`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${i}`:`Day ${i}`),
      focus: isUpper ? (lang==="th"?"‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô":"Upper") : (lang==="th"?"‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á":"Lower"),
      items:[...main, ...cardio]
    });
  }

  currentUser.workoutPlan = { level, goal, days, equip, createdAt: Date.now(), plan };
  saveUsers();
  renderWorkout();
}

function renderWorkoutPlan(wp){
  let html = `<div class="section">
    <h3 style="margin:0 0 6px">${currentUser.lang==="th"?"‡πÅ‡∏ú‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå":"Weekly Plan"}</h3>
    <div style="color:var(--muted);font-size:12px;font-weight:700;margin-bottom:10px">
      ${(currentUser.lang==="th"?"‡∏£‡∏∞‡∏î‡∏±‡∏ö":"Level")}: <b>${wp.level}</b> ‚Ä¢
      ${(currentUser.lang==="th"?"‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢":"Goal")}: <b>${wp.goal}</b> ‚Ä¢
      ${(currentUser.lang==="th"?"‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå":"Equipment")}: <b>${wp.equip}</b> ‚Ä¢
      ${(currentUser.lang==="th"?"‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå":"Days/week")}: <b>${wp.days}</b>
    </div>
  `;

  wp.plan.forEach(d=>{
    html += `<div class="section" style="margin-top:10px">
      <div style="font-weight:900;margin-bottom:6px">${escapeHtml(d.day)} ‚Äî ${escapeHtml(d.focus)}</div>
      <table>
        <tr>
          <th>${currentUser.lang==="th"?"‡∏ó‡πà‡∏≤":"Exercise"}</th>
          <th>${currentUser.lang==="th"?"‡πÄ‡∏ã‡πá‡∏ï":"Sets"}</th>
          <th>${currentUser.lang==="th"?"‡∏Ñ‡∏£‡∏±‡πâ‡∏á":"Reps"}</th>
          <th>${currentUser.lang==="th"?"‡∏û‡∏±‡∏Å":"Rest"}</th>
        </tr>
        ${d.items.map(it=>`
          <tr>
            <td style="text-align:left">${escapeHtml(it.name)}</td>
            <td>${it.sets}</td>
            <td>${it.reps}</td>
            <td>${it.rest? (it.rest + " " + (currentUser.lang==="th"?"‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ":"sec")) : "-"}</td>
          </tr>
        `).join("")}
      </table>
    </div>`;
  });

  html += `</div>`;
  return html;
}

function saveWorkoutNotes(){
  currentUser.workoutNotes = document.getElementById("workoutNotes").value;
  saveUsers();
  alert(currentUser.lang==="th"?"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ":"Saved ‚úÖ");
}

/* =========================================================
   Profile (User can edit, email locked)
========================================================= */
function renderProfile(){
  const u = currentUser;

  document.getElementById("pName").value = u.name || "";
  document.getElementById("pLname").value = u.lname || "";
  document.getElementById("pAge").value = u.age || 0;
  document.getElementById("pGender").value = u.gender || "other";
  document.getElementById("pWeight").value = u.weight || 0;
  document.getElementById("pHeight").value = u.height || 0;
  document.getElementById("profileGoal").value = u.goal || "maintain";
  document.getElementById("langSwitch").value = u.lang || "en";

  document.getElementById("profileInfo").innerHTML = `
    <div class="section">
      <table>
        <tr><th>User ID</th><td>${escapeHtml(u.id)}</td></tr>
        <tr><th>Username</th><td>${escapeHtml(u.user)}</td></tr>
        <tr><th>Email</th><td>${escapeHtml(u.email)}</td></tr>
        <tr><th>${u.lang==="th"?"‡∏ä‡∏∑‡πà‡∏≠":"Name"}</th><td>${escapeHtml(u.name)} ${escapeHtml(u.lname)}</td></tr>
        <tr><th>${u.lang==="th"?"‡∏≠‡∏≤‡∏¢‡∏∏":"Age"}</th><td>${u.age||0}</td></tr>
        <tr><th>${u.lang==="th"?"‡πÄ‡∏û‡∏®":"Gender"}</th><td>${escapeHtml(u.gender||"-")}</td></tr>
        <tr><th>${u.lang==="th"?"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å":"Weight"}</th><td>${u.weight||0}</td></tr>
        <tr><th>${u.lang==="th"?"‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á":"Height"}</th><td>${u.height||0}</td></tr>
      </table>
    </div>
  `;
}

function saveProfile(){
  // email locked: user cannot change it (we don't even provide input)
  currentUser.name = document.getElementById("pName").value.trim() || currentUser.name;
  currentUser.lname = document.getElementById("pLname").value.trim() || currentUser.lname;
  currentUser.age = Number(document.getElementById("pAge").value || currentUser.age);
  currentUser.gender = document.getElementById("pGender").value;
  currentUser.weight = Number(document.getElementById("pWeight").value || currentUser.weight);
  currentUser.height = Number(document.getElementById("pHeight").value || currentUser.height);
  currentUser.goal = document.getElementById("profileGoal").value;

  // update language via profile dropdown
  const newLang = document.getElementById("langSwitch").value;
  changeLanguage(newLang);

  // refresh target today
  ensureTodayHistory();
  saveUsers();

  alert(currentUser.lang==="th"?"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‚úÖ":"Updated ‚úÖ");
  renderProfile();
  renderHome(); renderFood();
}

function changeLanguage(lang){
  currentUser.lang = lang;
  setUiLang(lang);
  saveUsers();

  document.getElementById("topLang").innerText = `Language: ${String(currentUser.lang).toUpperCase()}`;

  applyAppI18n();
  if(!screenHome.classList.contains("hide")) renderHome();
  if(!screenFood.classList.contains("hide")) renderFood();
  if(!screenWorkout.classList.contains("hide")) renderWorkout();
  if(!screenProfile.classList.contains("hide")) renderProfile();
  renderStorageInfo();
}

/* =========================================================
   Storage info (show where stored)
========================================================= */
function renderStorageInfo(){
  const info = `
    <div class="disclaimer">
      <b>${currentUser.lang==="th"?"‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•":"Where data is stored"}</b>
      <div style="margin-top:6px">
        ‚Ä¢ LocalStorage Key (Users): <b>${LS_USERS}</b><br>
        ‚Ä¢ LocalStorage Key (Session): <b>${LS_SESSION}</b><br>
        ‚Ä¢ LocalStorage Key (UI Language): <b>${LS_UI_LANG}</b><br><br>
        ${currentUser.lang==="th"
          ? "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Frontend-only ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (Study Case)"
          : "Note: Frontend-only demo. Data is not stored on a server (Study Case)."}
      </div>
    </div>
  `;
  document.getElementById("storageInfo").innerHTML = info;
}

/* =========================================================
   Admin (Absolute power)
========================================================= */
function bootAdmin(){
  hideAll();
  adminWrap.classList.remove("hide");

  document.getElementById("adminLangSwitch").value = currentUser.lang;
  document.getElementById("adminLangLine").innerText = `Language: ${String(currentUser.lang).toUpperCase()}`;

  document.getElementById("t_admin_disclaimer").innerText = `${t("adminDis")}\n${t("study")}`;
  document.getElementById("t_admin_rules").innerText = t("adminRules");

  renderAdmin();
  startAdminTutorial(false);
}

function adminChangeLang(lang){
  currentUser.lang = lang;
  setUiLang(lang);
  saveUsers();

  document.getElementById("adminLangLine").innerText = `Language: ${String(currentUser.lang).toUpperCase()}`;
  document.getElementById("t_admin_disclaimer").innerText = `${t("adminDis")}\n${t("study")}`;
  document.getElementById("t_admin_rules").innerText = t("adminRules");
  document.getElementById("btnReplayAdminTutorial").innerText = t("replayAdminTut");

  renderAdmin();
}

let editingUserId = null;

function renderAdmin(){
  const q = (document.getElementById("adminSearch").value || "").trim().toLowerCase();
  const list = users; // admin can see all (absolute)

  const total = list.length;
  const totalUsers = list.filter(x=>x.role==="user").length;
  const totalAdmins = list.filter(x=>x.role==="admin").length;

  const langs = list.reduce((acc,u)=>{ acc[u.lang]=(acc[u.lang]||0)+1; return acc; }, {});
  const langText = Object.keys(langs).map(k=>`${k.toUpperCase()}:${langs[k]}`).join(" ‚Ä¢ ");

  document.getElementById("adminStats").innerHTML = `
    <div class="disclaimer">
      <b>${currentUser.lang==="th"?"‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö":"System Stats"}</b><br>
      ${currentUser.lang==="th"?"‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î":"Total"}: <b>${total}</b> ‚Ä¢
      Users: <b>${totalUsers}</b> ‚Ä¢
      Admins: <b>${totalAdmins}</b><br>
      ${currentUser.lang==="th"?"‡∏†‡∏≤‡∏©‡∏≤":"Languages"}: <b>${langText || "-"}</b>
    </div>
  `;

  const filtered = q ? list.filter(u =>
    (u.id||"").toLowerCase().includes(q) ||
    (u.user||"").toLowerCase().includes(q) ||
    (u.email||"").toLowerCase().includes(q) ||
    (u.role||"").toLowerCase().includes(q) ||
    (u.lang||"").toLowerCase().includes(q)
  ) : list;

  let html = `<table>
    <tr>
      <th>ID</th><th>Username</th><th>Email</th><th>Role</th><th>Lang</th><th>Online</th><th>Action</th>
    </tr>`;

  filtered.forEach(u=>{
    html += `<tr>
      <td>${escapeHtml(u.id)}</td>
      <td>${escapeHtml(u.user)}</td>
      <td>${escapeHtml(u.email)}</td>
      <td>${escapeHtml(u.role)}</td>
      <td>${String(u.lang||"en").toUpperCase()}</td>
      <td>${u.online ? "‚úÖ" : "-"}</td>
      <td>
        <button class="bA" style="margin:0;padding:8px 10px;border-radius:12px;box-shadow:none;width:auto"
          onclick="openAdminEdit('${escapeHtml(u.id)}')">
          ${currentUser.lang==="th"?"‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£":"Manage"}
        </button>
      </td>
    </tr>`;
  });

  html += `</table>`;
  document.getElementById("adminData").innerHTML = html;

  document.getElementById("btnReplayAdminTutorial").innerText = t("replayAdminTut");
}

function openAdminEdit(id){
  editingUserId = id;
  const u = users.find(x=>x.id===id);
  if(!u) return;

  document.getElementById("t_admin_edit_title").innerText = t("adminEditTitle");
  document.getElementById("t_admin_edit_note").innerText = t("adminEditNote");
  document.getElementById("adminEditResult").innerText = "";

  document.getElementById("eUser").value = u.user || "";
  document.getElementById("eEmail").value = u.email || "";
  document.getElementById("eName").value = u.name || "";
  document.getElementById("eLname").value = u.lname || "";
  document.getElementById("eAge").value = u.age || 0;
  document.getElementById("eGender").value = u.gender || "other";
  document.getElementById("eWeight").value = u.weight || 0;
  document.getElementById("eHeight").value = u.height || 0;
  document.getElementById("eGoal").value = u.goal || "maintain";
  document.getElementById("eLang").value = u.lang || "en";
  document.getElementById("eRole").value = u.role || "user";
  document.getElementById("ePass").value = "";

  adminEditOverlay.classList.remove("hide");
}

function closeAdminEdit(){
  adminEditOverlay.classList.add("hide");
  editingUserId = null;
}

function adminSaveUser(){
  const u = users.find(x=>x.id===editingUserId);
  if(!u) return;

  const newUser = document.getElementById("eUser").value.trim();
  const newEmail = document.getElementById("eEmail").value.trim();
  const newPass = document.getElementById("ePass").value.trim();

  // basic validate username rule
  if(newUser.length < 3){
    document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"?"Username ‡∏ï‡πâ‡∏≠‡∏á ‚â• 3":"Username must be ‚â• 3");
    return;
  }

  // uniqueness checks (except self)
  if(users.find(x=>x.id!==u.id && x.user.toLowerCase()===newUser.toLowerCase())){
    document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"?"Username ‡∏ã‡πâ‡∏≥":"Duplicate username");
    return;
  }
  if(newEmail && users.find(x=>x.id!==u.id && (x.email||"").toLowerCase()===newEmail.toLowerCase())){
    document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"?"Email ‡∏ã‡πâ‡∏≥":"Duplicate email");
    return;
  }

  // apply edits
  u.user = newUser;
  u.email = newEmail;
  u.name = document.getElementById("eName").value.trim();
  u.lname = document.getElementById("eLname").value.trim();
  u.age = Number(document.getElementById("eAge").value || 0);
  u.gender = document.getElementById("eGender").value;
  u.weight = Number(document.getElementById("eWeight").value || 0);
  u.height = Number(document.getElementById("eHeight").value || 0);
  u.goal = document.getElementById("eGoal").value;
  u.lang = document.getElementById("eLang").value;
  u.role = document.getElementById("eRole").value;

  if(newPass){
    if(newPass.length < 6 || !hasSpecialChar(newPass)){
      document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"
        ? "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á ‚â• 6 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©"
        : "Password must be ‚â• 6 and include special char");
      return;
    }
    u.pass = newPass;
  }

  users = sanitizeUsers(users);
  saveUsers();
  document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"?"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ":"Saved ‚úÖ");

  // if admin edited self language -> refresh admin UI
  renderAdmin();
}

function adminForceLogout(){
  const u = users.find(x=>x.id===editingUserId);
  if(!u) return;

  u.forceLogoutVersion = Number(u.forceLogoutVersion||0) + 1;
  u.online = false;
  saveUsers();

  document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"
    ? "‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (Local-only)"
    : "Force logout done ‚úÖ (Local-only)");

  // If the user is the same browser session user, it will kick on next check
  renderAdmin();
}

function adminDeleteUser(){
  const u = users.find(x=>x.id===editingUserId);
  if(!u) return;

  if(u.id === currentUser.id){
    document.getElementById("adminEditResult").innerText = (currentUser.lang==="th"
      ? "‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"
      : "Cannot delete yourself");
    return;
  }

  const ok = confirm(currentUser.lang==="th"
    ? `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${u.user}?`
    : `Delete user ${u.user}?`);
  if(!ok) return;

  users = users.filter(x=>x.id!==u.id);
  saveUsers();
  closeAdminEdit();
  renderAdmin();
}

function adminResetPassword(){
  const u = users.find(x=>x.id===editingUserId);
  if(!u) return;

  const random = "Reset@" + Math.floor(100000 + Math.random()*900000); // meets special char rule
  u.pass = random;
  saveUsers();
  document.getElementById("adminEditResult").innerText =
    (currentUser.lang==="th" ? `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà: ${random}` : `Reset ‚úÖ New pass: ${random}`);
  renderAdmin();
}

/* =========================================================
   Tutorials (Updated)
========================================================= */
let tutorialMode = null; // "user" | "admin"
let tutorialIndex = 0;

const USER_TUT = {
  en: [
    {step:"Step 1/6", title:"Welcome", body:"This is FitSense AI (study). You can track intake, burned calories and get AI suggestions.", highlight:null},
    {step:"Step 2/6", title:"Home Dashboard", body:"Home shows Target / Intake / Burned / Remaining. This is the main daily view.", highlight:"homeKpis"},
    {step:"Step 3/6", title:"Food Logging", body:"Go to Food to generate meals and log your intake (kcal).", highlight:"tabFood"},
    {step:"Step 4/6", title:"Workout Burned", body:"Go to Workout to log minutes and estimate calories burned (MET).", highlight:"tabWorkout"},
    {step:"Step 5/6", title:"Profile & Language", body:"You can edit your info and change language. Email is locked as identifier.", highlight:"tabProfile"},
    {step:"Step 6/6", title:"Storage Info", body:"Settings shows where data is stored (LocalStorage keys).", highlight:"tabSettings"},
  ],
  th: [
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1/6", title:"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö", body:"‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ FitSense AI (Study) ‡πÉ‡∏ä‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô/‡πÄ‡∏ú‡∏≤ ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ AI (‡∏à‡∏≥‡∏•‡∏≠‡∏á)", highlight:null},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2/6", title:"Dashboard ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", body:"‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏™‡∏£‡∏∏‡∏õ ‡πÄ‡∏õ‡πâ‡∏≤/‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß/‡πÄ‡∏ú‡∏≤‡πÑ‡∏õ/‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô", highlight:"homeKpis"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3/6", title:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£", body:"‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π AI ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô", highlight:"tabFood"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4/6", title:"‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ú‡∏≤‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ", body:"‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏≤ (MET)", highlight:"tabWorkout"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 5/6", title:"‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤", body:"‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà Email ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô", highlight:"tabProfile"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 6/6", title:"‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", body:"‡∏´‡∏ô‡πâ‡∏≤ Settings ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ data ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô LocalStorage (‡∏û‡∏£‡πâ‡∏≠‡∏° key)", highlight:"tabSettings"},
  ]
};

const ADMIN_TUT = {
  en: [
    {step:"Step 1/5", title:"Admin Warning", body:"Admin has absolute power (study). Use responsibly.", highlight:null},
    {step:"Step 2/5", title:"Search & List", body:"You can search and view all users here.", highlight:"adminSearch"},
    {step:"Step 3/5", title:"Manage User", body:"Click Manage to edit user, reset password, force logout, or delete.", highlight:"adminData"},
    {step:"Step 4/5", title:"Language Switch", body:"Admin can switch language from the top dropdown.", highlight:"adminLangSwitch"},
    {step:"Step 5/5", title:"Finish", body:"Always logout after admin actions.", highlight:"btnAdminLogout"},
  ],
  th: [
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1/5", title:"‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", body:"‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤) ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", highlight:null},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2/5", title:"‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠", body:"‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ", highlight:"adminSearch"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3/5", title:"‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", body:"‡∏Å‡∏î Manage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", highlight:"adminData"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4/5", title:"‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤", body:"‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å dropdown ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô", highlight:"adminLangSwitch"},
    {step:"‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 5/5", title:"‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", body:"‡∏Ñ‡∏ß‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠", highlight:"btnAdminLogout"},
  ]
};

function clearHighlight(){
  document.querySelectorAll(".highlight").forEach(el=>el.classList.remove("highlight"));
}
function applyHighlight(targetId){
  clearHighlight();
  if(!targetId) return;
  const el = document.getElementById(targetId);
  if(el) el.classList.add("highlight");
}
function openTutorial(){ tutorialOverlay.classList.remove("hide"); }
function closeTutorial(){ tutorialOverlay.classList.add("hide"); clearHighlight(); }

function startUserTutorial(forceReplay=false){
  if(!currentUser || currentUser.role!=="user") return;
  if(!forceReplay && currentUser.firstLaunchDone) return;
  tutorialMode="user"; tutorialIndex=0;
  openTutorial(); renderTutorialStep();
}

function startAdminTutorial(forceReplay=false){
  if(!currentUser || currentUser.role!=="admin") return;
  if(!forceReplay && currentUser.firstAdminTutDone) return;
  tutorialMode="admin"; tutorialIndex=0;
  openTutorial(); renderTutorialStep();
}

function renderTutorialStep(){
  const lang = currentUser.lang;
  const steps = (tutorialMode==="admin") ? (ADMIN_TUT[lang]||ADMIN_TUT.en) : (USER_TUT[lang]||USER_TUT.en);
  const s = steps[tutorialIndex];

  tutorialStepLabel.innerText = s.step;
  tutorialTitle.innerText = s.title;
  tutorialBody.innerText = s.body;
  tutorialDisclaimer.innerText = `‚Äú${t("study")}‚Äù`;

  btnTutorialBack.disabled = tutorialIndex===0;
  const last = tutorialIndex===steps.length-1;

  btnTutorialSkip.innerText = (lang==="th") ? "‡∏Ç‡πâ‡∏≤‡∏°" : "Skip";
  btnTutorialNext.innerText = last ? ((lang==="th")?"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô":"Start") : ((lang==="th")?"‡∏ñ‡∏±‡∏î‡πÑ‡∏õ":"Next");

  // Auto navigate highlight for user tutorial
  if(tutorialMode==="user"){
    if(s.highlight==="tabFood") goTab("food", true);
    if(s.highlight==="tabWorkout") goTab("workout", true);
    if(s.highlight==="tabProfile") goTab("profile", true);
    if(s.highlight==="tabSettings") goTab("settings", true);
    if(s.highlight==="homeKpis") goTab("home", true);
  }

  applyHighlight(s.highlight);
}

function tutorialNext(){
  const lang = currentUser.lang;
  const steps = (tutorialMode==="admin") ? (ADMIN_TUT[lang]||ADMIN_TUT.en) : (USER_TUT[lang]||USER_TUT.en);

  if(tutorialIndex < steps.length-1){
    tutorialIndex++;
    renderTutorialStep();
    return;
  }
  if(tutorialMode==="user") currentUser.firstLaunchDone = true;
  if(tutorialMode==="admin") currentUser.firstAdminTutDone = true;
  saveUsers();
  closeTutorial();
  if(tutorialMode==="user") goTab("home", true);
}

function tutorialBack(){
  if(tutorialIndex<=0) return;
  tutorialIndex--;
  renderTutorialStep();
}

function tutorialSkip(){
  if(tutorialMode==="user") currentUser.firstLaunchDone = true;
  if(tutorialMode==="admin") currentUser.firstAdminTutDone = true;
  saveUsers();
  closeTutorial();
  if(tutorialMode==="user") goTab("home", true);
}

/* =========================================================
   Auto login
========================================================= */
function tryAutoLogin(){
  const raw = localStorage.getItem(LS_SESSION);
  if(!raw) return false;
  try{
    const s = JSON.parse(raw);
    const u = users.find(x => x.user.toLowerCase() === String(s.username||"").toLowerCase());
    if(!u) return false;

    currentUser = u;
    currentUser.online = true;
    saveUsers();

    // If forced logout version mismatch -> cancel session
    if((s.forceLogoutVersion ?? 0) !== (currentUser.forceLogoutVersion ?? 0)){
      clearSession();
      return false;
    }

    // set UI language based on user
    setUiLang(currentUser.lang);

    if(currentUser.role==="admin") bootAdmin();
    else bootUserApp();

    return true;
  }catch{
    return false;
  }
}

/* =========================================================
   Init
========================================================= */
(function init(){
  // default ui language
  applyStaticI18n();

  // sync language selectors initial
  document.getElementById("regLangSwitch").value = getUiLang();
  document.getElementById("loginLangSwitch").value = getUiLang();
  document.getElementById("forgotLangSwitch").value = getUiLang();

  // admin search enter
  document.getElementById("adminSearch").addEventListener("keydown", (e)=>{
    if(e.key==="Enter") renderAdmin();
  });

  // Start with auto login or register
  if(!tryAutoLogin()){
    showRegister();
  }
})();
</script>

</body>
</html>
